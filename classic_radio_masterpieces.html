<!--
File name example (English): classic_radio_masterpieces.html
Vanilla JS + clean CSS (glass style)
-->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>24hr Radio & Masterpieces</title>
    <style>
        :root{
            --bg1:#0b1220;
            --bg2:#0f172a;
            --card:rgba(255,255,255,.08);
            --card2:rgba(255,255,255,.06);
            --stroke:rgba(255,255,255,.14);
            --text:#e5e7eb;
            --muted:#9ca3af;
            --accent1:#60a5fa;
            --accent2:#34d399;
            --danger:#ef4444;
            --warn:#f59e0b;
            --shadow:0 18px 60px rgba(0,0,0,.35);
            --radius:16px;
        }
        *{ box-sizing:border-box; }
        body{
            margin:0;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
            color:var(--text);
            background:
                    radial-gradient(1200px 800px at 20% 10%, rgba(96,165,250,.25), transparent 55%),
                    radial-gradient(900px 600px at 80% 20%, rgba(52,211,153,.18), transparent 55%),
                    linear-gradient(180deg, var(--bg1), var(--bg2));
            min-height:100vh;
            padding:18px;
        }
        .container{ max-width:980px; margin:0 auto; }
        .glass-card{
            background:linear-gradient(180deg, var(--card), var(--card2));
            border:1px solid var(--stroke);
            border-radius:var(--radius);
            box-shadow:var(--shadow);
            padding:18px;
            margin:14px 0;
            backdrop-filter: blur(10px);
        }
        h4{ margin:0 0 10px 0; font-size:18px; }
        label{ color:var(--text); }
        .form-input{
            width:100%;
            padding:11px 12px;
            border-radius:12px;
            border:1px solid rgba(255,255,255,.16);
            background:rgba(0,0,0,.25);
            color:var(--text);
            outline:none;
        }
        .form-input:focus{ border-color: rgba(96,165,250,.65); box-shadow: 0 0 0 3px rgba(96,165,250,.18); }
        .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
        .row > *{ flex:1; }
        .warning-box{
            border:1px solid rgba(245,158,11,.35);
            background:rgba(245,158,11,.10);
            padding:10px 12px;
            border-radius:12px;
        }
        .warning-text{ margin:0; font-size:13px; color:#fde68a; }
        .glass-button{
            appearance:none;
            border:1px solid rgba(255,255,255,.18);
            background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(59,130,246,.85));
            color:white;
            padding:10px 14px;
            border-radius:12px;
            cursor:pointer;
            font-weight:700;
            box-shadow: 0 10px 28px rgba(59,130,246,.25);
            transition: transform .08s ease, filter .15s ease;
        }
        .glass-button:hover{ filter:brightness(1.05); }
        .glass-button:active{ transform: translateY(1px); }
        .glass-button.secondary{
            background: linear-gradient(135deg, rgba(149,165,166,.95), rgba(127,140,141,.85));
            box-shadow: 0 10px 28px rgba(0,0,0,.25);
        }
        .glass-button.outline{
            background: rgba(255,255,255,.08);
            box-shadow:none;
        }

        .player-status{ display:flex; justify-content:flex-start; }
        .status-badge{
            display:inline-flex; align-items:center; gap:6px;
            font-size:12px;
            padding:6px 10px;
            border-radius:999px;
            border:1px solid rgba(255,255,255,.18);
            background: rgba(0,0,0,.22);
            color:var(--muted);
            user-select:none;
        }
        .status-badge.is-playing{ color:#bbf7d0; border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.10); }
        .status-badge.is-loading{ color:#bfdbfe; border-color: rgba(96,165,250,.35); background: rgba(96,165,250,.10); }
        .status-badge.is-stopped{ color:#e5e7eb; }
        .status-badge.is-error{ color:#fecaca; border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }

        #visualizer{
            width:100%;
            height:140px;
            border-radius:14px;
            border:1px solid rgba(255,255,255,.12);
            background: rgba(0,0,0,.25);
        }

        .player-controls{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:10px;
            flex-wrap:wrap;
            margin-top:14px;
        }
        .volume-range{
            width:220px;
            accent-color: var(--accent1);
        }

        /* Masterpiece */
        .masterpiece-card{ overflow:hidden; }
        .masterpiece-controls{ display:flex; justify-content:center; }
        .masterpiece-frame{
            border-radius:16px;
            border:1px solid rgba(255,255,255,.12);
            background: rgba(0,0,0,.22);
            overflow:hidden;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
        }
        .masterpiece-stage{
            position:relative;
            width:100%;
            height:420px;
            background: radial-gradient(600px 300px at 50% 30%, rgba(255,255,255,.10), transparent 60%);
        }
        .masterpiece-img{
            position:absolute; inset:0;
            width:100%; height:100%;
            object-fit:contain;
            opacity:0;
            transform: scale(1.01);
            transition: opacity .65s ease;
            will-change: opacity;
        }
        .masterpiece-img.is-active{ opacity:1; }
        .masterpiece-caption{
            padding:12px 2px 0 2px;
            color:var(--muted);
            font-size:13px;
            line-height:1.45;
        }
        .error-message{
            margin-top:10px;
            padding:10px 12px;
            border-radius:12px;
            border:1px solid rgba(239,68,68,.35);
            background: rgba(239,68,68,.10);
            color:#fecaca;
            display:none;
        }

        .small-note{ font-size:12px; color: var(--muted); margin-top:8px; }
    </style>
</head>
<body>
<div class="container">

    <div class="glass-card">
        <h4><b>24ì‹œê°„ í´ë˜ì‹ ë¼ë””ì˜¤ (24hr Classic Radio) &#038; ëª…í™” ê°ìƒ</b></h4>

        <div class="warning-box" style="margin-top:12px;">
            <p class="warning-text">ì¼ë¶€ ì±„ë„ì€ ë°©ì†¡êµ­ ì‚¬ì •ìœ¼ë¡œ ì‚¬ì „ ê³ ì§€ ì—†ì´ ì„œë¹„ìŠ¤ê°€ ì¤‘ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="row" style="margin-top:14px;">
            <div>
                <label style="display:block; margin-bottom:8px;"><b>ìŒì•… ì±„ë„ ì„ íƒ</b></label>
                <select id="stationSelect" class="form-input">
                    <optgroup label="Classic">
                        <option value="classic">Swiss Classic</option>
                        <option value="wqxr">WQXR</option>
                        <option value="radioClassique">Radio Classique</option>
                        <option value="franceMusique">France Musique</option>
                        <option value="npoKlassiek">NPO Klassiek (NPO Radio 4)</option>
                    </optgroup>
                    <optgroup label="Jazz">
                        <option value="jazz">Swiss Jazz</option>
                    </optgroup>
                    <optgroup label="Chillout / Ambient">
                        <option value="grooveSalad">SomaFM Groove Salad</option>
                        <option value="droneZone">SomaFM Drone Zone</option>
                        <option value="spaceStation">SomaFM Space Station Soma</option>
                    </optgroup>
                    <optgroup label="Electronic / Chill">
                        <option value="beatBlender">SomaFM Beat Blender</option>
                        <option value="nightride">Nightride FM (Synthwave)</option>
                        <option value="chillSynth">Nightride FM (ChillSynth)</option>
                    </optgroup>
                    <optgroup label="Indie / Alternative / Mix">
                        <option value="radioParadise">Radio Paradise (Main Mix)</option>
                    </optgroup>
                    <optgroup label="Lounge / Soft Pop">
                        <option value="lush">SomaFM Lush</option>
                        <option value="secretAgent">SomaFM Secret Agent</option>
                    </optgroup>
                    <optgroup label="POP">
                        <option value="poptron">SomaFM PopTron</option>
                    </optgroup>
                    <optgroup label="New Age">
                        <option value="deepSpaceOne">SomaFM Deep Space One</option>
                        <option value="fluid">SomaFM Fluid</option>
                    </optgroup>
                </select>
                <div class="small-note">â€» ìŠ¤íŠ¸ë¦¼ ì£¼ì†ŒëŠ” ê³µê°œëœ ë¼ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. (CORS/HTTPS ì •ì±…ì— ë”°ë¼ ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ì¬ìƒì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)</div>
            </div>

            <div style="max-width:320px;">
                <label for="vizSelect" style="display:block; margin-bottom:8px; font-weight:700;">ì‹œê°í™”</label>
                <select id="vizSelect" class="form-input">
                    <option value="bars">Bars (Log)</option>
                    <option value="spectrum">Spectrum (Line)</option>
                    <option value="waveform">Waveform</option>
                </select>
                <div class="small-note">â€» ìº”ë²„ìŠ¤ëŠ” AudioContextê°€ í™œì„±í™”ëœ ë’¤(ì¬ìƒ ë²„íŠ¼ í´ë¦­) ë™ì‘í•©ë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <div class="glass-card" style="text-align:center;">
        <div class="player-status" style="text-align:left; margin-bottom:10px;">
            <span id="statusBadge" class="status-badge is-stopped">ì •ì§€</span>
        </div>

        <canvas id="visualizer" width="900" height="140"></canvas>

        <div class="player-controls">
            <button id="btnPlayPause" class="glass-button">â–¶ ì¬ìƒ</button>
            <button id="btnMute" class="glass-button secondary">ğŸ”‡ ìŒì†Œê±°</button>

            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:12px; color:var(--muted);">ë³¼ë¥¨</span>
                <input id="volumeRange" type="range" min="0" max="1" step="0.01" value="0.8" class="volume-range" />
            </div>
        </div>

        <audio id="radioPlayer" crossorigin="anonymous" playsinline></audio>

        <div id="playerError" class="error-message"></div>
    </div>

    <div class="glass-card masterpiece-card">
        <div class="masterpiece-controls">
            <button id="btnMasterpiece" class="glass-button outline">ğŸ–¼ ëª…í™” ê°ìƒ ì‹œì‘</button>
        </div>

        <div id="masterpieceSection" style="display:none; margin-top:14px;">
            <div class="masterpiece-frame">
                <div class="masterpiece-stage">
                    <img id="masterpieceImageA" class="masterpiece-img is-active" alt="masterpiece A" />
                    <img id="masterpieceImageB" class="masterpiece-img" alt="masterpiece B" />
                </div>
            </div>
            <div id="masterpieceCaption" class="masterpiece-caption"></div>
            <div id="masterpieceError" class="error-message">ëª…í™”ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</div>
        </div>
    </div>

</div>

<script>
    /*********************************************************************
     * 1) RADIO STREAM LIST (HTTPS)
     * - ì¼ë¶€ ìŠ¤íŠ¸ë¦¼ì€ ë°©ì†¡ì‚¬/ë„¤íŠ¸ì›Œí¬ ì •ì±…ì— ë”°ë¼ ì°¨ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
     * - ìŠ¤íŠ¸ë¦¼ URLì€ ê³µê°œëœ ë¼ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
     *********************************************************************/
    const STATIONS = {
        // SRG SSR (Swiss) â€“ ê³µê°œ ìŠ¤íŠ¸ë¦¼
        classic: {
            title: "Swiss Classic",
            url: "https://stream.srg-ssr.ch/m/rsc_de/mp3_128"
        },
        jazz: {
            title: "Swiss Jazz",
            url: "https://stream.srg-ssr.ch/m/rsj/mp3_128"
        },

        // WQXR â€“ ê³µê°œ ë¼ì´ë¸Œ ìŠ¤íŠ¸ë¦¼
        wqxr: {
            title: "WQXR",
            url: "https://stream.wqxr.org/wqxr.aac"
        },

        // Radio Classique (FR) â€“ ê³µê°œ ìŠ¤íŠ¸ë¦¼(ë³€ê²½ ê°€ëŠ¥)
        radioClassique: {
            title: "Radio Classique",
            url: "https://radioclassique.ice.infomaniak.ch/radioclassique-high.mp3"
        },

        // France Musique â€“ ê³µê°œ ìŠ¤íŠ¸ë¦¼
        franceMusique: {
            title: "France Musique",
            url: "https://icecast.radiofrance.fr/francemusique-hifi.aac"
        },

        // NPO Klassiek (NPO Radio 4) â€“ ê³µê°œ ìŠ¤íŠ¸ë¦¼
        npoKlassiek: {
            title: "NPO Klassiek (NPO Radio 4)",
            url: "https://icecast.omroep.nl/radio4-bb-mp3"
        },

        // SomaFM â€“ ê³µì‹ ê³µê°œ ìŠ¤íŠ¸ë¦¼
        grooveSalad: { title: "SomaFM Groove Salad", url: "https://ice1.somafm.com/groovesalad-128-mp3" },
        droneZone:  { title: "SomaFM Drone Zone",   url: "https://ice1.somafm.com/dronezone-128-mp3" },
        spaceStation:{ title:"SomaFM Space Station Soma", url:"https://ice1.somafm.com/spacestation-128-mp3" },
        beatBlender:{ title: "SomaFM Beat Blender", url: "https://ice1.somafm.com/beatblender-128-mp3" },
        lush:       { title: "SomaFM Lush",         url: "https://ice1.somafm.com/lush-128-mp3" },
        secretAgent:{ title: "SomaFM Secret Agent", url: "https://ice1.somafm.com/secretagent-128-mp3" },
        poptron:    { title: "SomaFM PopTron",      url: "https://ice1.somafm.com/poptron-128-mp3" },
        deepSpaceOne:{ title:"SomaFM Deep Space One",url:"https://ice1.somafm.com/deepspaceone-128-mp3" },
        fluid:      { title: "SomaFM Fluid",        url: "https://ice1.somafm.com/fluid-128-mp3" },

        // Radio Paradise â€“ ê³µì‹ ê³µê°œ ìŠ¤íŠ¸ë¦¼
        radioParadise: { title: "Radio Paradise (Main Mix)", url: "https://stream.radioparadise.com/mp3-192" },

        // Nightride FM â€“ ê³µê°œ ìŠ¤íŠ¸ë¦¼(ë³€ê²½ ê°€ëŠ¥)
        // ë§Œì•½ ì¬ìƒì´ ì•ˆ ë˜ë©´, mp3 ëŒ€ì‹  m3u8/aacë¥¼ ì œê³µí•˜ëŠ” ë‹¤ë¥¸ ì—”ë“œí¬ì¸íŠ¸ë¡œ êµì²´í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        nightride:   { title: "Nightride FM (Synthwave)", url: "https://stream.nightride.fm/nightride.mp3" },
        chillSynth:  { title: "Nightride FM (ChillSynth)", url: "https://stream.nightride.fm/chillsynth.mp3" }
    };

    /*********************************************************************
     * 2) DOM
     *********************************************************************/
    const stationSelect = document.getElementById("stationSelect");
    const vizSelect = document.getElementById("vizSelect");
    const btnPlayPause = document.getElementById("btnPlayPause");
    const btnMute = document.getElementById("btnMute");
    const volumeRange = document.getElementById("volumeRange");
    const audio = document.getElementById("radioPlayer");
    const statusBadge = document.getElementById("statusBadge");
    const playerError = document.getElementById("playerError");

    const canvas = document.getElementById("visualizer");
    const ctx = canvas.getContext("2d");

    /*********************************************************************
     * 3) PLAYER STATE
     *********************************************************************/
    let isPlaying = false;

    // WebAudio (Visualizer)
    let audioCtx = null;
    let analyser = null;
    let sourceNode = null;
    let dataArray = null;
    let rafId = null;

    // Resize canvas for crisp rendering
    function resizeCanvas() {
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.floor(rect.width * dpr);
        canvas.height = Math.floor(rect.height * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function setStatus(type, text) {
        statusBadge.className = "status-badge " + type;
        statusBadge.textContent = text;
    }

    function showPlayerError(msg) {
        playerError.style.display = "block";
        playerError.textContent = msg;
    }
    function clearPlayerError() {
        playerError.style.display = "none";
        playerError.textContent = "";
    }

    /*********************************************************************
     * 4) STREAM SETUP
     *********************************************************************/
    function applyStation(key) {
        const st = STATIONS[key];
        if (!st) return;

        clearPlayerError();
        setStatus("is-loading", "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦");

        // ì¬ìƒ ì¤‘ì´ë©´ ëŠê¹€ ì—†ì´ êµì²´ë¥¼ ì‹œë„ (ë¸Œë¼ìš°ì € ì •ì±…/ìŠ¤íŠ¸ë¦¼ íŠ¹ì„±ìƒ ì ê¹ ëŠê¸¸ ìˆ˜ ìˆìŒ)
        audio.src = st.url;
        audio.load();

        // ì´ë¯¸ ì¬ìƒ ì¤‘ì´ì—ˆë‹¤ë©´ ìë™ ì¬ìƒ ì‹œë„
        if (isPlaying) {
            audio.play().catch(err => {
                setStatus("is-error", "ì¬ìƒ ì‹¤íŒ¨");
                showPlayerError("ì¬ìƒì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ìë™ì¬ìƒ ì •ì±…/ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜ ê°€ëŠ¥)\n" + err);
                isPlaying = false;
                updatePlayButton();
            });
        }
    }

    function updatePlayButton() {
        btnPlayPause.textContent = isPlaying ? "â¸ ì¼ì‹œì •ì§€" : "â–¶ ì¬ìƒ";
    }

    // select change
    stationSelect.addEventListener("change", () => {
        applyStation(stationSelect.value);
    });

    /*********************************************************************
     * 5) VISUALIZER (Web Audio API)
     *********************************************************************/
    function ensureAudioGraph() {
        if (audioCtx) return;

        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        analyser.smoothingTimeConstant = 0.85;

        // IMPORTANT: createMediaElementSourceëŠ” 1ë²ˆë§Œ ìƒì„± ê°€ëŠ¥
        sourceNode = audioCtx.createMediaElementSource(audio);

        sourceNode.connect(analyser);
        analyser.connect(audioCtx.destination);

        dataArray = new Uint8Array(analyser.frequencyBinCount);
    }

    function startVisualizer() {
        stopVisualizer();
        ensureAudioGraph();

        const mode = () => vizSelect.value;

        const draw = () => {
            const w = canvas.getBoundingClientRect().width;
            const h = canvas.getBoundingClientRect().height;

            // background
            ctx.clearRect(0, 0, w, h);
            ctx.fillStyle = "rgba(0,0,0,0.20)";
            ctx.fillRect(0, 0, w, h);

            // grid
            ctx.strokeStyle = "rgba(255,255,255,0.06)";
            ctx.lineWidth = 1;
            for (let i = 1; i <= 6; i++) {
                const y = (h / 7) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
                ctx.stroke();
            }

            const m = mode();

            if (m === "waveform") {
                analyser.getByteTimeDomainData(dataArray);

                ctx.lineWidth = 2;
                ctx.strokeStyle = "rgba(96,165,250,0.95)";
                ctx.beginPath();

                const slice = w / dataArray.length;
                let x = 0;

                for (let i = 0; i < dataArray.length; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = (v * h) / 2;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                    x += slice;
                }
                ctx.stroke();

            } else {
                analyser.getByteFrequencyData(dataArray);

                if (m === "bars") {
                    const barCount = 64;
                    const step = Math.floor(dataArray.length / barCount);
                    const barW = w / barCount;

                    for (let i = 0; i < barCount; i++) {
                        // log-ish weighting
                        const idx = i * step;
                        const raw = dataArray[idx] / 255;
                        const v = Math.pow(raw, 0.60);

                        const barH = v * (h - 10);
                        const x = i * barW;
                        const y = h - barH;

                        // gradient-ish by alpha only (no hard-coded colors beyond 1)
                        ctx.fillStyle = `rgba(52,211,153,${0.15 + v * 0.85})`;
                        ctx.fillRect(x + 2, y, Math.max(2, barW - 4), barH);
                    }

                } else if (m === "spectrum") {
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = "rgba(52,211,153,0.95)";
                    ctx.beginPath();

                    const n = 256;
                    const step = Math.floor(dataArray.length / n);
                    for (let i = 0; i < n; i++) {
                        const v = (dataArray[i * step] / 255);
                        const y = h - (v * (h - 10)) - 5;
                        const x = (i / (n - 1)) * w;
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                }
            }

            rafId = requestAnimationFrame(draw);
        };

        rafId = requestAnimationFrame(draw);
    }

    function stopVisualizer() {
        if (rafId) cancelAnimationFrame(rafId);
        rafId = null;
    }

    vizSelect.addEventListener("change", () => {
        if (isPlaying) startVisualizer();
    });

    /*********************************************************************
     * 6) CONTROLS
     *********************************************************************/
    btnPlayPause.addEventListener("click", async () => {
        clearPlayerError();

        try {
            // iOS/Safari/autoplay policy: must resume context on user gesture
            ensureAudioGraph();
            if (audioCtx.state === "suspended") await audioCtx.resume();

            if (!audio.src) {
                applyStation(stationSelect.value);
            }

            if (!isPlaying) {
                setStatus("is-loading", "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦");
                await audio.play();
                isPlaying = true;
                setStatus("is-playing", "ì¬ìƒ ì¤‘");
                startVisualizer();
            } else {
                audio.pause();
                isPlaying = false;
                setStatus("is-stopped", "ì¼ì‹œì •ì§€");
                stopVisualizer();
            }
            updatePlayButton();
        } catch (err) {
            isPlaying = false;
            updatePlayButton();
            setStatus("is-error", "ì¬ìƒ ì‹¤íŒ¨");
            showPlayerError("ì¬ìƒì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ì •ì±…/ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜ ê°€ëŠ¥)\n" + err);
        }
    });

    btnMute.addEventListener("click", () => {
        audio.muted = !audio.muted;
        btnMute.textContent = audio.muted ? "ğŸ”ˆ ìŒì†Œê±° í•´ì œ" : "ğŸ”‡ ìŒì†Œê±°";
    });

    volumeRange.addEventListener("input", () => {
        audio.volume = Math.max(0, Math.min(1, parseFloat(volumeRange.value)));
    });

    // audio events
    audio.addEventListener("playing", () => {
        if (isPlaying) setStatus("is-playing", "ì¬ìƒ ì¤‘");
    });
    audio.addEventListener("waiting", () => {
        if (isPlaying) setStatus("is-loading", "ë²„í¼ë§â€¦");
    });
    audio.addEventListener("pause", () => {
        if (!audio.ended && isPlaying === false) setStatus("is-stopped", "ì¼ì‹œì •ì§€");
    });
    audio.addEventListener("error", () => {
        setStatus("is-error", "ì˜¤ë¥˜");
        showPlayerError("ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì±„ë„ì„ ì„ íƒí•´ ë³´ì„¸ìš”.");
        isPlaying = false;
        updatePlayButton();
        stopVisualizer();
    });

    // ì´ˆê¸°ê°’
    audio.volume = parseFloat(volumeRange.value);
    updatePlayButton();
    setStatus("is-stopped", "ì •ì§€");
    applyStation(stationSelect.value);

    /*********************************************************************
     * 7) MASTERPIECE (Wikimedia Commons Random File)
     * - MediaWiki API: CORS ì§€ì›( origin=* )
     * - íŒŒì¼(namespace=6)ì—ì„œ ëœë¤ 1ê°œ ê°€ì ¸ì™€ ì´ë¯¸ì§€ URL + ì„¤ëª… êµ¬ì„±
     *********************************************************************/
    const btnMasterpiece = document.getElementById("btnMasterpiece");
    const masterpieceSection = document.getElementById("masterpieceSection");
    const imgA = document.getElementById("masterpieceImageA");
    const imgB = document.getElementById("masterpieceImageB");
    const cap = document.getElementById("masterpieceCaption");
    const masterpieceError = document.getElementById("masterpieceError");

    let masterpieceRunning = false;
    let masterpieceTimer = null;
    let activeIsA = true;

    async function fetchRandomArtwork() {
        // 1) random file title
        const r1 = await fetch("https://commons.wikimedia.org/w/api.php?action=query&format=json&origin=*&list=random&rnnamespace=6&rnlimit=1");
        const j1 = await r1.json();
        const title = j1?.query?.random?.[0]?.title;
        if (!title) throw new Error("No random file");

        // 2) imageinfo (url + descriptionurl + extmetadata)
        const url = "https://commons.wikimedia.org/w/api.php?action=query&format=json&origin=*&prop=imageinfo&iiprop=url|extmetadata&titles=" + encodeURIComponent(title);
        const r2 = await fetch(url);
        const j2 = await r2.json();
        const pages = j2?.query?.pages;
        const page = pages ? pages[Object.keys(pages)[0]] : null;
        const info = page?.imageinfo?.[0];
        if (!info?.url) throw new Error("No image url");

        const meta = info.extmetadata || {};
        const artist = meta.Artist?.value ? stripHtml(meta.Artist.value) : "";
        const artTitle = meta.ObjectName?.value ? stripHtml(meta.ObjectName.value) : stripHtml(title.replace(/^File:/, ""));
        const date = meta.DateTimeOriginal?.value || meta.Date?.value ? stripHtml((meta.DateTimeOriginal?.value || meta.Date?.value)) : "";
        const license = meta.LicenseShortName?.value ? stripHtml(meta.LicenseShortName.value) : "";
        const credit = meta.Credit?.value ? stripHtml(meta.Credit.value) : "";
        const source = meta.ImageDescription?.value ? stripHtml(meta.ImageDescription.value) : "";

        return {
            imgUrl: info.url,
            caption: [
                `<b>${escapeHtml(artTitle)}</b>`,
                artist ? `ì‘ê°€: ${escapeHtml(artist)}` : "",
                date ? `ì—°ë„: ${escapeHtml(date)}` : "",
                credit ? `ì¶œì²˜: ${escapeHtml(credit)}` : "",
                license ? `ë¼ì´ì„ ìŠ¤: ${escapeHtml(license)}` : "",
                `<span style="opacity:.85;">(Wikimedia Commons)</span>`
            ].filter(Boolean).join(" Â· ")
        };
    }

    function stripHtml(s){
        return String(s).replace(/<[^>]*>/g, "").replace(/\s+/g," ").trim();
    }
    function escapeHtml(s){
        return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function showNextMasterpiece() {
        masterpieceError.style.display = "none";
        try {
            const art = await fetchRandomArtwork();

            const nextImg = activeIsA ? imgB : imgA;
            const prevImg = activeIsA ? imgA : imgB;

            // preload
            await new Promise((resolve, reject) => {
                nextImg.onload = () => resolve();
                nextImg.onerror = () => reject(new Error("Image load failed"));
                nextImg.src = art.imgUrl;
            });

            // crossfade
            nextImg.classList.add("is-active");
            prevImg.classList.remove("is-active");
            activeIsA = !activeIsA;

            cap.innerHTML = art.caption;
        } catch (e) {
            masterpieceError.style.display = "block";
        }
    }

    function startMasterpiece() {
        if (masterpieceRunning) return;
        masterpieceRunning = true;
        masterpieceSection.style.display = "block";
        btnMasterpiece.textContent = "â¹ ëª…í™” ê°ìƒ ì¤‘ì§€";

        showNextMasterpiece();
        masterpieceTimer = setInterval(showNextMasterpiece, 20000); // 20ì´ˆë§ˆë‹¤ êµì²´
    }

    function stopMasterpiece() {
        masterpieceRunning = false;
        btnMasterpiece.textContent = "ğŸ–¼ ëª…í™” ê°ìƒ ì‹œì‘";
        clearInterval(masterpieceTimer);
        masterpieceTimer = null;
        masterpieceSection.style.display = "none";
    }

    btnMasterpiece.addEventListener("click", () => {
        if (!masterpieceRunning) startMasterpiece();
        else stopMasterpiece();
    });
</script>
</body>
</html>
