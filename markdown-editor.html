<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Markdown Editor & Viewer</title>

    <!-- Marked.js (Markdown parser) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root{
            --bg:#f6f7fb;
            --card:#ffffff;
            --line:#e5e7eb;
            --text:#111827;
            --muted:#6b7280;
            --primary:#2563eb;
            --primary2:#1d4ed8;
            --green:#10b981;
            --green2:#059669;
            --danger:#ef4444;
            --danger2:#dc2626;
            --shadow:0 10px 30px rgba(0,0,0,.06);
            --radius:16px;
        }
        *{box-sizing:border-box}
        body{
            margin:0;
            background:var(--bg);
            color:var(--text);
            font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
        }
        .page-wrap{max-width:980px;margin:18px auto;padding:0 14px}
        h4{margin:0 0 6px 0;font-size:18px}
        p{margin:0 0 14px 0;color:var(--muted)}

        .glass-card{
            background:var(--card);
            border:1px solid var(--line);
            border-radius:var(--radius);
            box-shadow:var(--shadow);
            padding:14px;
            margin:12px 0;
        }

        /* Upload */
        .upload-area{
            border:2px dashed rgba(37,99,235,.25);
            border-radius:18px;
            padding:28px 18px;
            text-align:center;
            background:linear-gradient(180deg, rgba(37,99,235,.06), rgba(37,99,235,.02));
            cursor:pointer;
            transition:.15s ease;
            position:relative;
            overflow:hidden;
        }
        .upload-area:hover{border-color:rgba(37,99,235,.45)}
        .upload-area.dragover{
            border-color:rgba(37,99,235,.75);
            background:linear-gradient(180deg, rgba(37,99,235,.10), rgba(37,99,235,.03));
            transform:translateY(-1px);
        }
        .upload-icon{font-size:34px;margin-bottom:8px}
        .upload-text{font-weight:900;font-size:15px}
        .upload-subtext{margin-top:6px;color:var(--muted);font-size:12px}
        #fileInput{
            position:absolute;
            inset:0;
            opacity:0;
            cursor:pointer;
        }

        /* Buttons */
        .button-group{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
        .glass-button{
            border:0;
            border-radius:14px;
            padding:10px 14px;
            background:linear-gradient(135deg,#3B82F6,#1D4ED8);
            color:#fff;
            font-weight:900;
            cursor:pointer;
            box-shadow:0 10px 20px rgba(37,99,235,.18);
            user-select:none;
        }
        .glass-button:hover{filter:brightness(.98)}
        .glass-button:active{transform:translateY(1px)}
        .glass-button.secondary{
            background:linear-gradient(135deg,#eef2ff,#e0e7ff);
            color:#1f2937;
            box-shadow:0 10px 20px rgba(2,6,23,.06);
            border:1px solid var(--line);
        }
        .glass-button.danger{
            background:linear-gradient(135deg,var(--danger),var(--danger2));
            box-shadow:0 10px 20px rgba(220,38,38,.18);
        }

        /* Info box */
        .info-box{
            margin:12px 0;
            padding:12px 14px;
            border-radius:16px;
            border:1px solid rgba(16,185,129,.25);
            background:rgba(16,185,129,.08);
            color:#064e3b;
        }
        .info-box ul{margin:6px 0 0 0}

        /* Stats */
        .stats-card{
            background:#fff;
            border:1px solid var(--line);
            border-radius:16px;
            box-shadow:var(--shadow);
            overflow:hidden;
            margin:12px 0;
        }
        .stats-header{
            padding:10px 14px;
            font-weight:900;
            background:#f3f4f6;
            border-bottom:1px solid var(--line);
        }
        .stats-content{
            padding:12px 14px;
            display:grid;
            grid-template-columns:repeat(3,minmax(0,1fr));
            gap:10px;
        }
        @media (max-width:860px){
            .stats-content{grid-template-columns:1fr}
        }
        .stats-item{color:#374151}
        .stats-item strong{color:#111827}

        /* Editor container */
        .editor-container{display:none}
        .editor-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:10px;
            flex-wrap:wrap;
            margin-bottom:10px;
        }
        .editor-header h3{margin:0;font-size:16px}
        .mode-toggle{
            display:flex;
            gap:8px;
            padding:6px;
            background:#f3f4f6;
            border:1px solid var(--line);
            border-radius:14px;
        }
        .mode-button{
            border:1px solid var(--line);
            background:#fff;
            border-radius:12px;
            padding:9px 12px;
            cursor:pointer;
            font-weight:900;
            color:#374151;
            box-shadow:0 6px 14px rgba(0,0,0,.05);
        }
        .mode-button.active{
            border-color:rgba(37,99,235,.35);
            box-shadow:0 10px 18px rgba(37,99,235,.14);
            color:#111827;
        }

        textarea#editorText{
            width:100%;
            min-height:320px;
            resize:vertical;
            padding:12px 14px;
            border:1px solid var(--line);
            border-radius:16px;
            outline:none;
            font:13.5px/1.7 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
            background:#fff;
        }
        textarea#editorText:focus{
            border-color:rgba(37,99,235,.5);
            box-shadow:0 0 0 4px rgba(37,99,235,.12);
        }

        /* Viewer */
        #viewerContent{
            display:none;
            border:1px solid var(--line);
            border-radius:16px;
            padding:14px;
            background:#fff;
            overflow:auto;
            min-height:320px;
        }
        /* Markdown rendering styles */
        #viewerContent h1,#viewerContent h2,#viewerContent h3,#viewerContent h4,#viewerContent h5,#viewerContent h6{
            color:#1e3a8a;margin:1.1em 0 .6em 0;
        }
        #viewerContent h1{border-bottom:2px solid rgba(59,130,246,.25);padding-bottom:8px}
        #viewerContent p{color:#111827}
        #viewerContent a{color:var(--primary);text-decoration:none}
        #viewerContent a:hover{text-decoration:underline}
        #viewerContent code{
            background:rgba(59,130,246,.10);
            padding:2px 6px;
            border-radius:6px;
            font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
            font-size:.92em;
        }
        #viewerContent pre{
            background:rgba(30,64,175,.08);
            padding:14px;
            border-radius:12px;
            overflow:auto;
            border-left:4px solid #3B82F6;
        }
        #viewerContent pre code{background:none;padding:0}
        #viewerContent blockquote{
            border-left:4px solid #3B82F6;
            padding:6px 12px;
            margin:12px 0;
            background:rgba(59,130,246,.06);
            border-radius:10px;
            color:#374151;
        }
        #viewerContent table{
            width:100%;
            border-collapse:collapse;
            margin:12px 0;
        }
        #viewerContent th,#viewerContent td{
            border:1px solid rgba(59,130,246,.25);
            padding:8px 10px;
            text-align:left;
        }
        #viewerContent th{
            background:rgba(59,130,246,.12);
            color:#1e3a8a;
        }
        #viewerContent img{max-width:100%;border-radius:12px}

        /* Save menu */
        .save-menu{
            position:absolute;
            right:0;
            top:44px;
            min-width:220px;
            background:#fff;
            border:1px solid var(--line);
            border-radius:14px;
            box-shadow:0 14px 30px rgba(0,0,0,.10);
            padding:6px;
            z-index:20;
        }
        .save-menu-item{
            width:100%;
            text-align:left;
            padding:10px 10px;
            border:0;
            background:#fff;
            border-radius:12px;
            cursor:pointer;
            font-weight:800;
            color:#111827;
        }
        .save-menu-item:hover{background:#f3f4f6}

        /* Modal */
        .modal-overlay{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.35);
            display:none;
            align-items:center;
            justify-content:center;
            padding:16px;
            z-index:50;
        }
        .modal-overlay.active{display:flex}
        .modal-container{
            width:min(920px, 100%);
            max-height:80vh;
            overflow:auto;
            background:#fff;
            border:1px solid var(--line);
            border-radius:18px;
            box-shadow:0 30px 70px rgba(0,0,0,.20);
        }
        .modal-header{
            position:sticky;
            top:0;
            background:#fff;
            border-bottom:1px solid var(--line);
            padding:12px 14px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:10px;
            z-index:2;
        }
        .modal-header h3{margin:0;font-size:16px}
        .modal-close{
            border:1px solid var(--line);
            background:#fff;
            border-radius:12px;
            width:38px;height:38px;
            cursor:pointer;
            font-size:20px;
            font-weight:900;
        }
        .modal-body{padding:14px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
        @media (max-width:860px){.modal-body{grid-template-columns:1fr}}

        .syntax-item{
            border:1px solid var(--line);
            border-radius:16px;
            padding:12px;
            background:#fff;
        }
        .syntax-title{display:flex;gap:8px;align-items:center;font-weight:900;margin-bottom:8px}
        .syntax-example{
            background:#0b1220;
            color:#e5e7eb;
            border-radius:12px;
            padding:10px 12px;
            white-space:pre-wrap;
            font:12.5px/1.6 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
            overflow:auto;
        }
        .syntax-preview{
            margin-top:10px;
            border:1px dashed #d1d5db;
            border-radius:12px;
            padding:10px 12px;
            background:#fafafa;
        }
        .syntax-actions{margin-top:10px;text-align:right}
        .syntax-insert-btn{
            border:0;
            border-radius:12px;
            padding:9px 12px;
            font-weight:900;
            cursor:pointer;
            background:linear-gradient(135deg,#3B82F6,#1D4ED8);
            color:#fff;
        }

        /* small helper */
        .muted{color:var(--muted)}
    </style>
</head>

<body>
<div class="page-wrap">
    <h4><b>ë§ˆí¬ë‹¤ìš´ í¸ì§‘ê¸° &amp; ë·°ì–´ (Markdown Editor &amp; Viewer)</b></h4>
    <p style="font-size:14px;">
        ë§ˆí¬ë‹¤ìš´ íŒŒì¼(.md, .markdown)ì„ ì—´ê±°ë‚˜ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¬´ë£Œë¡œ ì„¤ì¹˜ ì—†ì´ ì‚¬ìš©ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </p>

    <div class="glass-card" id="uploadCard">
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">MD íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
            <div class="upload-subtext">ì§€ì› í˜•ì‹: .md, .markdown</div>
            <input type="file" id="fileInput" accept=".md,.markdown" />
        </div>
        <div class="button-group" style="margin-top:20px;">
            <button class="glass-button secondary" type="button" onclick="createNewFile()">âœ¨ ìƒˆ íŒŒì¼ ë§Œë“¤ê¸°</button>
        </div>
    </div>

    <div class="info-box">
        <strong>ğŸ’¡ ì‚¬ìš© íŒ:</strong>
        <ul style="margin:5px 0;padding-left:20px;">
            <li>ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ MD íŒŒì¼ì„ ì—´ê±°ë‚˜ â€œìƒˆ íŒŒì¼ ë§Œë“¤ê¸°â€ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</li>
            <li>í¸ì§‘ ëª¨ë“œì—ì„œ ë§ˆí¬ë‹¤ìš´ì„ ì‘ì„±í•˜ê³  ë·°ì–´ ëª¨ë“œì—ì„œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ í™•ì¸í•˜ì„¸ìš”</li>
            <li>ì‘ì„±í•œ ë‚´ìš©ì€ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥í•˜ê±°ë‚˜ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
        </ul>
    </div>

    <div class="stats-card" id="statsArea" style="display:none;">
        <div class="stats-header">ğŸ“Š ë¬¸ì„œ ì •ë³´</div>
        <div class="stats-content">
            <div class="stats-item"><strong>ğŸ“„ íŒŒì¼ëª…:</strong> <span id="statsFileName"></span></div>
            <div class="stats-item"><strong>ğŸ“ ë¬¸ì ìˆ˜:</strong> <span id="statsChars"></span></div>
            <div class="stats-item"><strong>ğŸ“ ì¤„ ìˆ˜:</strong> <span id="statsLines"></span></div>
        </div>
    </div>

    <div class="glass-card editor-container" id="editorContainer">
        <div class="editor-header">
            <h3 id="editorTitle">ë§ˆí¬ë‹¤ìš´ í¸ì§‘</h3>

            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                <button class="mode-button" id="syntaxBtn" type="button" onclick="openSyntaxModal()" style="margin:0;">ğŸ“– ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•</button>
                <div class="mode-toggle">
                    <button class="mode-button active" id="editModeBtn" type="button" onclick="switchMode('edit')">âœï¸ í¸ì§‘</button>
                    <button class="mode-button" id="viewModeBtn" type="button" onclick="switchMode('view')">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</button>
                </div>
            </div>
        </div>

        <textarea id="editorText" placeholder="ë§ˆí¬ë‹¤ìš´ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        <div id="viewerContent"></div>

        <div class="button-group" style="margin-top:12px;">
            <button class="glass-button" type="button" onclick="copyText()">ğŸ“‹ í…ìŠ¤íŠ¸ ë³µì‚¬</button>

            <div style="position:relative;display:inline-block;">
                <button class="glass-button secondary" type="button" onclick="event.stopPropagation(); toggleSaveMenu();">ğŸ’¾ íŒŒì¼ë¡œ ì €ì¥ â–¼</button>
                <div id="saveMenu" class="save-menu" style="display:none;" onclick="event.stopPropagation();">
                    <button class="save-menu-item" type="button" onclick="downloadFile('md')">ğŸ“„ Markdown (.md/.markdown)</button>
                    <button class="save-menu-item" type="button" onclick="downloadFile('html')">ğŸŒ HTML (.html)</button>
                    <button class="save-menu-item" type="button" onclick="downloadFile('txt')">ğŸ“ í…ìŠ¤íŠ¸ (.txt)</button>
                </div>
            </div>

            <button class="glass-button danger" type="button" onclick="reset()">ğŸ”„ ìƒˆë¡œ ì‹œì‘</button>
        </div>

        <div class="muted" style="text-align:center;margin-top:10px;font-size:12px;">
            â€» ë‹¨ì–´/ë¬¸ë‹¨ ë¯¸ë¦¬ë³´ê¸°ëŠ” marked.jsê°€ ë¡œë“œë˜ì–´ì•¼ ì •ìƒ ë™ì‘í•©ë‹ˆë‹¤.
        </div>
    </div>

    <!-- ë§ˆí¬ë‹¤ìš´ ë¬¸ë²• ëª¨ë‹¬ -->
    <div class="modal-overlay" id="syntaxModal" onclick="closeSyntaxModalOnOverlay(event)">
        <div class="modal-container" onclick="event.stopPropagation();">
            <div class="modal-header">
                <h3>ğŸ“– ë§ˆí¬ë‹¤ìš´ ë¬¸ë²• ê°€ì´ë“œ</h3>
                <button class="modal-close" type="button" onclick="closeSyntaxModal()">Ã—</button>
            </div>
            <div class="modal-body" id="syntaxModalBody"></div>
        </div>
    </div>
</div>

<script>
    /* Marked.js ì„¤ì • */
    if (typeof marked !== 'undefined') {
        marked.setOptions({ breaks:true, gfm:true });
    }

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadCard = document.getElementById('uploadCard');
    const editorContainer = document.getElementById('editorContainer');
    const editorText = document.getElementById('editorText');
    const viewerContent = document.getElementById('viewerContent');
    const statsArea = document.getElementById('statsArea');
    const statsFileName = document.getElementById('statsFileName');
    const statsChars = document.getElementById('statsChars');
    const statsLines = document.getElementById('statsLines');
    const editModeBtn = document.getElementById('editModeBtn');
    const viewModeBtn = document.getElementById('viewModeBtn');
    const editorTitle = document.getElementById('editorTitle');

    let currentFileName = '';
    let currentFileExtension = '.md';
    let currentMode = 'edit';

    /* í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ */
    uploadArea.addEventListener('click', () => fileInput.click());

    /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ */
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (!files || files.length === 0) return;

        const file = files[0];
        const name = (file.name || '').toLowerCase();
        if (name.endsWith('.md') || name.endsWith('.markdown') || file.type === 'text/markdown') {
            handleFile(file);
        } else {
            alert('ë§ˆí¬ë‹¤ìš´ íŒŒì¼(.md, .markdown)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        }
    });

    /* íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ */
    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length > 0) handleFile(e.target.files[0]);
    });

    /* íŒŒì¼ ì²˜ë¦¬ */
    async function handleFile(file) {
        const lower = (file.name || '').toLowerCase();
        if (lower.endsWith('.markdown')) {
            currentFileName = file.name.replace(/\.markdown$/i, '');
            currentFileExtension = '.markdown';
        } else if (lower.endsWith('.md')) {
            currentFileName = file.name.replace(/\.md$/i, '');
            currentFileExtension = '.md';
        } else {
            currentFileName = file.name || 'document';
            currentFileExtension = '.md';
        }

        uploadCard.style.display = 'none';
        statsArea.style.display = 'none';
        editorContainer.style.display = 'block';

        try {
            const text = await file.text();
            editorText.value = text;
            updateStats();
            updateViewer();
            switchMode('view');
        } catch (err) {
            alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            uploadCard.style.display = 'block';
            editorContainer.style.display = 'none';
        }
    }

    /* ìƒˆ íŒŒì¼ ë§Œë“¤ê¸° */
    function createNewFile() {
        currentFileName = 'new_file';
        currentFileExtension = '.md';
        uploadCard.style.display = 'none';
        statsArea.style.display = 'none';
        editorContainer.style.display = 'block';
        editorText.value = '';
        updateStats();
        updateViewer();
        switchMode('edit');
        editorText.focus();
    }

    /* ëª¨ë“œ ì „í™˜ */
    function switchMode(mode) {
        currentMode = mode;
        const syntaxBtn = document.getElementById('syntaxBtn');

        if (mode === 'edit') {
            editorText.style.display = 'block';
            viewerContent.style.display = 'none';
            editModeBtn.classList.add('active');
            viewModeBtn.classList.remove('active');
            editorTitle.textContent = 'ë§ˆí¬ë‹¤ìš´ í¸ì§‘';
            if (syntaxBtn) syntaxBtn.style.display = 'inline-block';
        } else {
            updateViewer();
            editorText.style.display = 'none';
            viewerContent.style.display = 'block';
            editModeBtn.classList.remove('active');
            viewModeBtn.classList.add('active');
            editorTitle.textContent = 'ë§ˆí¬ë‹¤ìš´ ë¯¸ë¦¬ë³´ê¸°';
            if (syntaxBtn) syntaxBtn.style.display = 'none';
        }
    }

    /* ë·°ì–´ ì—…ë°ì´íŠ¸ */
    function updateViewer() {
        const text = editorText.value || '';
        if (typeof marked !== 'undefined') {
            viewerContent.innerHTML = marked.parse(text);
        } else {
            viewerContent.innerHTML =
                '<p style="color:#EF4444;font-weight:900;">âš ï¸ ë§ˆí¬ë‹¤ìš´ íŒŒì„œë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (marked.js)</p>' +
                '<pre>' + escapeHtml(text) + '</pre>';
        }
        updateStats();
    }

    /* HTML escape */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /* í†µê³„ */
    function updateStats() {
        const text = editorText.value || '';
        const charCount = text.length;
        const lineCount = text.length ? text.split('\n').length : 0;

        statsChars.textContent = `${charCount.toLocaleString('ko-KR')} ì`;
        statsLines.textContent = `${lineCount.toLocaleString('ko-KR')} ì¤„`;

        if (currentFileName && currentFileName !== 'new_file') {
            statsFileName.textContent = currentFileName + (currentFileExtension || '.md');
            statsArea.style.display = 'block';
        } else {
            statsArea.style.display = 'none';
        }
    }

    /* í¸ì§‘ ë³€ê²½ */
    editorText.addEventListener('input', () => {
        if (currentMode === 'view') updateViewer();
        updateStats();
    });

    /* ë³µì‚¬ */
    async function copyText() {
        const text = editorText.value || '';
        try{
            await navigator.clipboard.writeText(text);
            alert('í…ìŠ¤íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }catch(e){
            editorText.select();
            document.execCommand('copy');
            alert('í…ìŠ¤íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
    }

    /* ì €ì¥ ë©”ë‰´ */
    function toggleSaveMenu() {
        const menu = document.getElementById('saveMenu');
        const isOpen = (menu.style.display === 'block');
        if (!isOpen) {
            menu.style.display = 'block';
            setTimeout(() => document.addEventListener('click', closeSaveMenuOnOutsideClick), 0);
        } else {
            closeSaveMenu();
        }
    }
    function closeSaveMenuOnOutsideClick(event) {
        const menu = document.getElementById('saveMenu');
        const saveWrap = event.target.closest('[onclick*="toggleSaveMenu"]');
        if (!menu.contains(event.target) && !saveWrap) closeSaveMenu();
    }
    function closeSaveMenu() {
        const menu = document.getElementById('saveMenu');
        menu.style.display = 'none';
        document.removeEventListener('click', closeSaveMenuOnOutsideClick);
    }

    /* íŒŒì¼ ì €ì¥ */
    function downloadFile(format='md') {
        closeSaveMenu();

        const text = editorText.value || '';
        let content = text;
        let mimeType = 'text/markdown;charset=utf-8';
        let extension = currentFileExtension || '.md';

        const baseFileName =
                  (currentFileName && currentFileName !== 'new_file')
                      ? currentFileName
                      : ('markdown_' + new Date().toISOString().slice(0,10));

        if (format === 'html') {
            mimeType = 'text/html;charset=utf-8';
            extension = '.html';
            const htmlContent = (typeof marked !== 'undefined') ? marked.parse(text) : ('<pre>' + escapeHtml(text) + '</pre>');
            content = `<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>${escapeHtml(baseFileName)}</title>
<style>
  body{max-width:800px;margin:0 auto;padding:20px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;line-height:1.7;color:#111}
  h1,h2,h3,h4,h5,h6{color:#1E40AF;margin-top:1.4em}
  h1{border-bottom:2px solid rgba(59,130,246,.25);padding-bottom:8px}
  code{background:rgba(59,130,246,.12);padding:2px 6px;border-radius:6px;font-family:ui-monospace,Menlo,Consolas,monospace}
  pre{background:rgba(30,64,175,.08);padding:14px;border-radius:12px;overflow:auto;border-left:4px solid #3B82F6}
  pre code{background:none;padding:0}
  blockquote{border-left:4px solid #3B82F6;padding-left:12px;color:#374151;background:rgba(59,130,246,.06);border-radius:10px;margin:12px 0}
  table{width:100%;border-collapse:collapse;margin:12px 0}
  th,td{border:1px solid rgba(59,130,246,.25);padding:8px 10px;text-align:left}
  th{background:rgba(59,130,246,.12);color:#1E40AF}
  a{color:#2563eb;text-decoration:none}
  a:hover{text-decoration:underline}
  img{max-width:100%;height:auto;border-radius:10px}
</style>
</head>
<body>
${htmlContent}
</body>
</html>`;
        } else if (format === 'txt') {
            mimeType = 'text/plain;charset=utf-8';
            extension = '.txt';
        } else {
            // md: ì—…ë¡œë“œ íŒŒì¼ì´ .markdown ì´ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€, ìƒˆíŒŒì¼ì€ .md
            mimeType = 'text/markdown;charset=utf-8';
            extension = (currentFileName && currentFileName !== 'new_file') ? (currentFileExtension || '.md') : '.md';
        }

        const blob = new Blob([content], { type:mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = baseFileName + extension;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    /* ë¦¬ì…‹ */
    function reset() {
        if (!confirm('ì •ë§ ìƒˆë¡œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) return;
        uploadCard.style.display = 'block';
        statsArea.style.display = 'none';
        editorContainer.style.display = 'none';
        fileInput.value = '';
        editorText.value = '';
        viewerContent.innerHTML = '';
        currentFileName = '';
        currentFileExtension = '.md';
        switchMode('edit');
    }

    /* ë¬¸ë²• ë°ì´í„° */
    const markdownSyntax = [
        { title:'ì œëª© (Headers)', icon:'ğŸ“Œ', example:'# ì œëª© 1\n## ì œëª© 2\n### ì œëª© 3\n#### ì œëª© 4\n##### ì œëª© 5\n###### ì œëª© 6', preview:'# ì œëª© 1\n## ì œëª© 2\n### ì œëª© 3' },
        { title:'êµµê²Œ (Bold)', icon:'**', example:'**êµµì€ í…ìŠ¤íŠ¸**', preview:'**êµµì€ í…ìŠ¤íŠ¸**' },
        { title:'ê¸°ìš¸ì„ (Italic)', icon:'*', example:'*ê¸°ìš¸ì„ í…ìŠ¤íŠ¸*', preview:'*ê¸°ìš¸ì„ í…ìŠ¤íŠ¸*' },
        { title:'ì·¨ì†Œì„  (Strikethrough)', icon:'~~', example:'~~ì·¨ì†Œì„  í…ìŠ¤íŠ¸~~', preview:'~~ì·¨ì†Œì„  í…ìŠ¤íŠ¸~~' },
        { title:'ë§í¬ (Link)', icon:'ğŸ”—', example:'[ë§í¬ í…ìŠ¤íŠ¸](https://example.com)', preview:'[ë§í¬ í…ìŠ¤íŠ¸](https://example.com)' },
        { title:'ì´ë¯¸ì§€ (Image)', icon:'ğŸ–¼ï¸', example:'![ì´ë¯¸ì§€ ì„¤ëª…](ì´ë¯¸ì§€URL.jpg)', preview:'![ì´ë¯¸ì§€ ì„¤ëª…](ì´ë¯¸ì§€URL.jpg)' },
        { title:'ì¸ë¼ì¸ ì½”ë“œ', icon:'`', example:'`ì½”ë“œ`', preview:'`ì½”ë“œ`' },
        { title:'ì½”ë“œ ë¸”ë¡', icon:'```', example:'```javascript\nconsole.log("Hello");\n```', preview:'```javascript\nconsole.log("Hello");\n```' },
        { title:'ìˆœì„œ ì—†ëŠ” ëª©ë¡', icon:'â€¢', example:'- í•­ëª© 1\n- í•­ëª© 2\n  - í•˜ìœ„ í•­ëª©', preview:'- í•­ëª© 1\n- í•­ëª© 2' },
        { title:'ìˆœì„œ ìˆëŠ” ëª©ë¡', icon:'1.', example:'1. í•­ëª© 1\n2. í•­ëª© 2\n3. í•­ëª© 3', preview:'1. í•­ëª© 1\n2. í•­ëª© 2' },
        { title:'ì¸ìš©êµ¬', icon:'>', example:'> ì¸ìš©êµ¬ ë‚´ìš©', preview:'> ì¸ìš©êµ¬ ë‚´ìš©' },
        { title:'ìˆ˜í‰ì„ ', icon:'---', example:'---', preview:'---' },
        { title:'í‘œ (Table)', icon:'ğŸ“Š', example:'| í—¤ë” 1 | í—¤ë” 2 |\n|--------|--------|\n| ì…€ 1   | ì…€ 2   |', preview:'| í—¤ë” 1 | í—¤ë” 2 |\n|--------|--------|\n| ì…€ 1   | ì…€ 2   |' },
        { title:'ì²´í¬ë°•ìŠ¤', icon:'â˜‘ï¸', example:'- [ ] ë¯¸ì™„ë£Œ ì‘ì—…\n- [x] ì™„ë£Œëœ ì‘ì—…', preview:'- [ ] ë¯¸ì™„ë£Œ ì‘ì—…\n- [x] ì™„ë£Œëœ ì‘ì—…' },
        { title:'ì¤„ë°”ê¿ˆ', icon:'â†©ï¸', example:'ì²« ë²ˆì§¸ ì¤„  \në‘ ë²ˆì§¸ ì¤„', preview:'ì²« ë²ˆì§¸ ì¤„  \në‘ ë²ˆì§¸ ì¤„' },
        { title:'ì°¸ì¡° ìŠ¤íƒ€ì¼ ë§í¬', icon:'ğŸ”–', example:'[ë§í¬ í…ìŠ¤íŠ¸][ref]\n\n[ref]: https://example.com', preview:'[ë§í¬ í…ìŠ¤íŠ¸][ref]' },
        { title:'ìë™ ë§í¬', icon:'ğŸŒ', example:'<https://example.com>', preview:'<https://example.com>' }
    ];

    /* ëª¨ë‹¬ */
    function openSyntaxModal() {
        const modal = document.getElementById('syntaxModal');
        const modalBody = document.getElementById('syntaxModalBody');

        modalBody.innerHTML = markdownSyntax.map((s, i) => `
    <div class="syntax-item">
      <div class="syntax-title"><span>${s.icon}</span><span>${s.title}</span></div>
      <div class="syntax-example">${escapeHtml(s.example)}</div>
      ${s.preview ? `<div class="syntax-preview">${typeof marked !== 'undefined' ? marked.parse(s.preview) : escapeHtml(s.preview)}</div>` : ''}
      <div class="syntax-actions">
        <button class="syntax-insert-btn" type="button" onclick="insertSyntax(${i})">ì…ë ¥</button>
      </div>
    </div>
  `).join('');

        modal.classList.add('active');
    }
    function closeSyntaxModal() {
        document.getElementById('syntaxModal').classList.remove('active');
    }
    function closeSyntaxModalOnOverlay(e) {
        if (e.target && e.target.id === 'syntaxModal') closeSyntaxModal();
    }
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeSyntaxModal();
    });

    /* ì‚½ì… */
    function insertSyntax(index) {
        const s = markdownSyntax[index];
        const ta = editorText;
        const start = ta.selectionStart;
        const end = ta.selectionEnd;
        const value = ta.value || '';

        const before = value.substring(0, start);
        const after = value.substring(end);
        const insertText = s.example;

        ta.value = before + insertText + after;

        const newPos = start + insertText.length;
        ta.setSelectionRange(newPos, newPos);
        ta.focus();

        updateStats();
        if (currentMode === 'view') updateViewer();
        closeSyntaxModal();
    }

    /* ì´ˆê¸° */
    updateStats();
    switchMode('edit');
</script>
</body>
</html>
