<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gacha Probability Calculator | ê²Œì„ ì•„ì´í…œ ë½‘ê¸° í™•ë¥  ê³„ì‚°ê¸°</title>
    <meta name="description" content="í™•ë¥ í˜• ì•„ì´í…œ(ê°€ì± ) ë½‘ê¸°ì—ì„œ ëª©í‘œ ì•„ì´í…œì„ ëª©í‘œ ê°œìˆ˜ ì´ìƒ íšë“í•  ëˆ„ì  í™•ë¥ ì„ ê³„ì‚°í•˜ê³ , ëˆ„ì í™•ë¥  ê·¸ë˜í”„ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. (ì„ íƒ: ì²œì¥ ì‹œìŠ¤í…œ)" />
    <style>
        :root{
            --bg1:#f5f7fb;
            --bg2:#eef3ff;
            --card: rgba(255,255,255,.72);
            --card2: rgba(255,255,255,.55);
            --stroke: rgba(44, 90, 160, .22);
            --text:#111827;
            --muted:#4b5563;
            --blue:#2563eb;
            --blue2:#1e40af;
            --green:#16a34a;
            --red:#dc2626;
            --shadow: 0 18px 45px rgba(17,24,39,.12);
            --radius: 14px;
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        *{box-sizing:border-box}
        body{
            margin:0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Malgun Gothic", Arial, sans-serif;
            color:var(--text);
            background: radial-gradient(1200px 800px at 20% 10%, #dbeafe 0%, transparent 55%),
            radial-gradient(900px 700px at 80% 20%, #e9d5ff 0%, transparent 55%),
            linear-gradient(180deg, var(--bg1), var(--bg2));
            min-height:100vh;
        }

        .wrap{
            max-width: 980px;
            margin: 24px auto 60px;
            padding: 0 14px;
        }

        .page-title{
            display:flex;
            align-items:center;
            gap:10px;
            margin: 0 0 10px 0;
        }
        .page-title h1{
            font-size: 22px;
            margin:0;
            letter-spacing:-.3px;
        }
        .page-title .badge{
            font-size:12px;
            padding:4px 10px;
            border-radius:999px;
            border:1px solid var(--stroke);
            background: rgba(255,255,255,.6);
            color: var(--blue2);
        }

        .lead{
            margin: 6px 0 18px 0;
            color: var(--muted);
            font-size: 14px;
            line-height: 1.55;
        }

        .glass-card{
            background: var(--card);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 16px 16px;
            margin: 14px 0;
        }

        .grid{
            display:grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }
        @media (max-width: 760px){
            .grid{ grid-template-columns: 1fr; }
        }

        label{
            font-weight: 800;
            font-size: 13px;
            display:block;
            margin-bottom:6px;
            color:#111827;
        }

        .form-input{
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border-radius: 12px;
            border: 2px solid rgba(59,130,246,.25);
            background: rgba(255,255,255,.7);
            outline: none;
            transition: .15s ease;
        }
        .form-input:focus{
            border-color: rgba(37,99,235,.65);
            box-shadow: 0 0 0 4px rgba(37,99,235,.12);
        }
        .form-input.error{
            border-color: rgba(220,38,38,.65);
            box-shadow: 0 0 0 4px rgba(220,38,38,.10);
        }
        .help{
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
            line-height: 1.45;
        }

        .checkbox-row{
            display:flex;
            gap: 10px;
            align-items:center;
            flex-wrap: wrap;
            margin-top: 4px;
        }
        .checkbox-row input{ transform: translateY(1px); }

        .btn-row{
            display:flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 6px;
        }

        .glass-button{
            border: 1px solid var(--stroke);
            background: rgba(255,255,255,.7);
            color: #0f172a;
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 900;
            cursor: pointer;
            transition: .15s ease;
            box-shadow: 0 12px 24px rgba(17,24,39,.10);
            user-select: none;
        }
        .glass-button:hover{ transform: translateY(-1px); }
        .glass-button:active{ transform: translateY(0px); }

        .glass-button.primary{
            background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(30,64,175,.95));
            border-color: rgba(37,99,235,.55);
            color: white;
        }
        .glass-button.gray{
            background: linear-gradient(135deg, rgba(149,165,166,.95), rgba(127,140,141,.95));
            border-color: rgba(107,114,128,.55);
            color: white;
        }

        .error-message{
            display:none;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid rgba(220,38,38,.35);
            background: rgba(220,38,38,.07);
            color: #991b1b;
            font-size: 13px;
            font-weight: 800;
            margin: 10px 0;
            white-space: pre-wrap;
        }

        pre#result{
            background: rgba(255,255,255,.78);
            border: 3px inset #c0c0c0;
            padding: 12px 12px;
            cursor: text;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: var(--mono);
            font-size: 12.5px;
            line-height: 1.55;
            border-radius: 10px;
            min-height: 140px;
            margin: 0;
        }

        .chart-wrap{
            margin-top: 12px;
            background: rgba(255,255,255,.78);
            border: 3px inset #c0c0c0;
            border-radius: 10px;
            padding: 10px;
        }
        canvas{ display:block; max-width:100%; height:auto; }

        .tiny-note{
            margin-top: 8px;
            font-size: 12px;
            color: var(--muted);
            text-align:center;
            line-height: 1.55;
        }
    </style>
</head>

<body>
<div class="wrap">
    <div class="page-title">
        <h1>ê²Œì„ ì•„ì´í…œ ë½‘ê¸° í™•ë¥  ê³„ì‚°ê¸°</h1>
        <span class="badge">Binomial + Pity(ë‹¨ìˆœ ëª¨ë¸)</span>
    </div>
    <p class="lead">
        í™•ë¥ í˜• ì•„ì´í…œ ë½‘ê¸°ì—ì„œ <b>ëª©í‘œ ì•„ì´í…œì„ ëª©í‘œ ê°œìˆ˜ ì´ìƒ</b> íšë“í•  ëˆ„ì  í™•ë¥ ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
        ì²œì¥(í”¼í‹°) ì‹œìŠ¤í…œì€ <b>â€œpityCountíšŒ ì´ìƒì´ë©´ 1ê°œëŠ” í™•ì •â€</b>ìœ¼ë¡œ ë‹¨ìˆœí™”í•œ ëª¨ë¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    </p>

    <div class="glass-card">
        <div class="grid">
            <div>
                <label for="boxPrice">1íšŒ ë½‘ê¸° ë¹„ìš© (ì›)</label>
                <input type="number" id="boxPrice" class="form-input" min="1" value="3000" />
                <div class="help">ì˜ˆ: 3000</div>
            </div>

            <div>
                <label for="itemProb">ì•„ì´í…œì´ ë‚˜ì˜¬ í™•ë¥  (%)</label>
                <input type="number" id="itemProb" class="form-input" min="0" max="100" step="0.01" value="5" />
                <div class="help">ì˜ˆ: 0.5, 1, 5, 12.34</div>
            </div>

            <div>
                <label for="totalDraws">ì´ ë½‘ê¸° íšŸìˆ˜ (íšŒ)</label>
                <input type="number" id="totalDraws" class="form-input" min="1" value="5" />
                <div class="help">ê·¸ë˜í”„ëŠ” ìµœëŒ€ 200í¬ì¸íŠ¸ë¡œ ì œí•œë©ë‹ˆë‹¤.</div>
            </div>

            <div>
                <label for="targetCount">ëª©í‘œ ì•„ì´í…œ ê°œìˆ˜</label>
                <input type="number" id="targetCount" class="form-input" min="1" value="1" />
                <div class="help">ì˜ˆ: 1ê°œ ì´ìƒ / 2ê°œ ì´ìƒ â€¦</div>
            </div>
        </div>

        <div class="checkbox-row" style="margin-top: 10px;">
            <label style="margin:0; font-weight:900;">
                <input type="checkbox" id="usePity" checked onchange="togglePity()">
                ì²œì¥ ì‹œìŠ¤í…œ ì‚¬ìš©
            </label>
            <span class="help" style="margin:0;">(ì²´í¬ í•´ì œ ì‹œ ì¼ë°˜ ì´í•­ë¶„í¬ ëˆ„ì  í™•ë¥ )</span>
        </div>

        <div id="pityInputWrapper" style="margin-top: 10px;">
            <label for="pityCount">ì²œì¥ ì‹œìŠ¤í…œ íšŸìˆ˜ (íšŒ) [pity system]</label>
            <input type="number" id="pityCount" class="form-input" min="1" value="90" />
            <div class="help">ë‹¨ìˆœ ëª¨ë¸: ì´ ë½‘ê¸° íšŸìˆ˜ n â‰¥ pityCount ì´ë©´ â€œëª©í‘œ ê°œìˆ˜ ì´ìƒ í™•ë¥ â€ì„ 1ë¡œ ì²˜ë¦¬(ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ ê¸°ì¤€).</div>
        </div>

        <div class="btn-row">
            <button class="glass-button primary" type="button" onclick="itemCalculate()">ğŸ² ë½‘ê¸° í™•ë¥  ê³„ì‚°í•˜ê¸°</button>
            <button class="glass-button gray" type="button" onclick="resetAll()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>

        <div id="error-message" class="error-message"></div>
    </div>

    <div class="glass-card">
        <pre id="result">ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</pre>
        <div class="chart-wrap" style="margin-top:12px;">
            <canvas id="chart" width="400" height="280"></canvas>
        </div>
        <div class="tiny-note">
            â€» ì²œì¥(í”¼í‹°) ì‹œìŠ¤í…œì€ ê²Œì„ë§ˆë‹¤ ê·œì¹™ì´ ë‹¬ë¼, ì •í™•í•œ í™•ë¥ /ê¸°ëŒ€ê°’ì„ ë‚´ë ¤ë©´ â€œì²œì¥ ë„ë‹¬ ì‹œ í™•ì • ë°©ì‹(ë¦¬ì…‹ ì—¬ë¶€, í™•ì • ì¹´ìš´íŠ¸, 50/50 ë“±)â€ì„ ëª¨ë¸ë§í•´ì•¼ í•©ë‹ˆë‹¤.
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function togglePity() {
        const isChecked = document.getElementById("usePity").checked;
        document.getElementById("pityInputWrapper").style.display = isChecked ? "block" : "none";
    }

    function showError(msg){
        const el = document.getElementById("error-message");
        el.textContent = msg;
        el.style.display = "block";
    }
    function hideError(){
        const el = document.getElementById("error-message");
        el.style.display = "none";
        el.textContent = "";
    }

    // ì´í•­ê³„ìˆ˜ (kê°€ ì»¤ë„ ì–´ëŠ ì •ë„ ë²„íŒ€. nì´ ë§¤ìš° í¬ë©´ ì •í™•ë„/ì„±ëŠ¥ ì´ìŠˆ ê°€ëŠ¥)
    function combination(n, k) {
        if (k > n) return 0;
        if (k === 0 || k === n) return 1;
        k = Math.min(k, n - k);
        let res = 1;
        for (let i = 1; i <= k; i++) {
            res = (res * (n - i + 1)) / i;
        }
        return res;
    }

    // ì´í•­ë¶„í¬: P(X >= targetCount)
    function cumulativeProbMultiple(n, targetCount, p) {
        let prob = 0;
        for (let k = targetCount; k <= n; k++) {
            prob += combination(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
        }
        return prob;
    }

    // ì²œì¥(ë‹¨ìˆœ): n < pityCountë©´ ì´í•­ë¶„í¬, n >= pityCountë©´ 1ë¡œ ë‹¨ìˆœí™”
    function cumProbPityMultiple(n, targetCount, p, pityCount) {
        if (n < pityCount) return cumulativeProbMultiple(n, targetCount, p);
        return 1;
    }

    // 1ê°œ íšë“ê¹Œì§€ ê¸°ëŒ€ ë½‘ê¸°(ì²œì¥ í¬í•¨) - â€œìµœëŒ€ MíšŒì— ë¬´ì¡°ê±´ 1ê°œâ€ì¸ ê¸°í•˜ë¶„í¬ ì ˆë‹¨(ë‹¨ìˆœ)
    function expectedDraws(p, M) {
        let expected = 0;
        for (let k = 1; k < M; k++) {
            expected += k * Math.pow(1 - p, k - 1) * p;
        }
        expected += M * Math.pow(1 - p, M - 1);
        return expected;
    }

    function fmtWon(n){
        return Math.round(n).toLocaleString("ko-KR") + "ì›";
    }

    function markInvalid(input, isBad){
        input.classList.toggle("error", !!isBad);
    }

    function itemCalculate() {
        hideError();

        const boxPriceEl = document.getElementById("boxPrice");
        const itemProbEl = document.getElementById("itemProb");
        const totalDrawsEl = document.getElementById("totalDraws");
        const targetCountEl = document.getElementById("targetCount");
        const usePityEl = document.getElementById("usePity");
        const pityCountEl = document.getElementById("pityCount");

        const boxPrice = parseFloat(boxPriceEl.value);
        const p = parseFloat(itemProbEl.value) / 100;
        const totalDraws = parseInt(totalDrawsEl.value, 10);
        const targetCount = parseInt(targetCountEl.value, 10);
        const usePity = usePityEl.checked;
        const pityCount = usePity ? parseInt(pityCountEl.value, 10) : null;

        // validation
        const badBox = isNaN(boxPrice) || boxPrice <= 0;
        const badP = isNaN(p) || p <= 0 || p > 1;
        const badN = isNaN(totalDraws) || totalDraws <= 0;
        const badT = isNaN(targetCount) || targetCount <= 0;
        const badM = usePity && (isNaN(pityCount) || pityCount <= 0);

        markInvalid(boxPriceEl, badBox);
        markInvalid(itemProbEl, badP);
        markInvalid(totalDrawsEl, badN);
        markInvalid(targetCountEl, badT);
        if (usePity) markInvalid(pityCountEl, badM);

        if (badBox || badP || badN || badT || badM) {
            showError("ëª¨ë“  ì…ë ¥ê°’ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.\n(í™•ë¥ ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•˜ë©°, ë¹„ìš©/íšŸìˆ˜/ëª©í‘œê°œìˆ˜ëŠ” 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.)");
            return;
        }

        // output
        let output = `[ í™•ë¥ í˜• ì•„ì´í…œ ë½‘ê¸° ê³„ì‚°ê¸° ê²°ê³¼ ]\n\n`;
        output += `1íšŒ ë½‘ê¸° ë¹„ìš© : ${boxPrice.toLocaleString("ko-KR")}ì›\n`;
        output += `ì•„ì´í…œ í™•ë¥  : ${(p * 100).toFixed(3)}%\n`;
        output += usePity ? `ì²œì¥ ì‹œìŠ¤í…œ íšŸìˆ˜ : ${pityCount}íšŒ\n` : `ì²œì¥ ì‹œìŠ¤í…œ : ë¯¸ì ìš©\n`;
        output += `ì´ ë½‘ê¸° íšŸìˆ˜ : ${totalDraws}íšŒ\n`;
        output += `ëª©í‘œ ì•„ì´í…œ ê°œìˆ˜ : ${targetCount}ê°œ\n\n`;

        // cumulative probability at N
        const cumProb = usePity
            ? cumProbPityMultiple(totalDraws, targetCount, p, pityCount)
            : cumulativeProbMultiple(totalDraws, targetCount, p);

        output += `ì´ ${totalDraws}íšŒ ë½‘ê¸° ì‹œ ì›í•˜ëŠ” ì•„ì´í…œ ${targetCount}ê°œ ì´ìƒ ì–»ì„ í™•ë¥ : ${(cumProb * 100).toFixed(2)}%\n\n`;

        // expectation (only meaningful for targetCount=1 in this simple model)
        if (usePity) {
            const expDraws = expectedDraws(p, pityCount);
            const avgCost = expDraws * boxPrice;
            output += `ì›í•˜ëŠ” ì•„ì´í…œ 1ê°œ íšë“ í‰ê·  ë½‘ê¸° íšŸìˆ˜ (ì²œì¥ ê³ ë ¤/ë‹¨ìˆœ): ${expDraws.toFixed(2)}íšŒ\n`;
            output += `ì›í•˜ëŠ” ì•„ì´í…œ 1ê°œ íšë“ í‰ê·  ë¹„ìš© (ë‹¨ìˆœ): ${fmtWon(avgCost)}\n\n`;
        } else {
            // geometric expectation (no pity) for 1 item
            const expNoPity = 1 / p;
            output += `ì›í•˜ëŠ” ì•„ì´í…œ 1ê°œ íšë“ í‰ê·  ë½‘ê¸° íšŸìˆ˜ (ì²œì¥ ì—†ìŒ/ì´ë¡ ): ${expNoPity.toFixed(2)}íšŒ\n`;
            output += `ì›í•˜ëŠ” ì•„ì´í…œ 1ê°œ íšë“ í‰ê·  ë¹„ìš© (ì´ë¡ ): ${fmtWon(expNoPity * boxPrice)}\n\n`;
        }

        // table
        const limit = Math.min(
            totalDraws,
            usePity ? Math.min(pityCount + 10, 200) : 200
        );

        output += `ë½‘ê¸° íšŸìˆ˜ë³„ ëˆ„ì  í™•ë¥  (${usePity ? "ì²œì¥ ë°˜ì˜(ë‹¨ìˆœ)" : "ì²œì¥ ë¯¸ì‚¬ìš©"})\n`;
        output += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
        for (let i = 1; i <= limit; i++) {
            const pr = usePity
                ? cumProbPityMultiple(i, targetCount, p, pityCount)
                : cumulativeProbMultiple(i, targetCount, p);
            output += `${String(i).padStart(3, " ")}íšŒ : ${(pr * 100).toFixed(2)}%\n`;
        }

        document.getElementById("result").textContent = output;

        // chart
        const labels = [];
        const series = [];

        for (let i = 1; i <= limit; i++) {
            const pr = usePity
                ? cumProbPityMultiple(i, targetCount, p, pityCount)
                : cumulativeProbMultiple(i, targetCount, p);
            labels.push(i);
            series.push(Number((pr * 100).toFixed(2)));
        }

        const ctx = document.getElementById("chart").getContext("2d");
        if (window.myChart) window.myChart.destroy();

        window.myChart = new Chart(ctx, {
            type: "line",
            data: {
                labels,
                datasets: [{
                    label: "ëˆ„ì  í™•ë¥  (%)",
                    data: series,
                    fill: false,
                    tension: 0.2,
                    pointRadius: 2,
                    pointHoverRadius: 4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: "ì‹œë„ íšŸìˆ˜" } },
                    y: { beginAtZero: true, max: 100, title: { display: true, text: "ëˆ„ì  í™•ë¥  (%)" } }
                },
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `ëˆ„ì  í™•ë¥ : ${ctx.raw}%`
                        }
                    }
                }
            }
        });
    }

    function resetAll(){
        hideError();
        document.getElementById("boxPrice").value = 3000;
        document.getElementById("itemProb").value = 5;
        document.getElementById("totalDraws").value = 5;
        document.getElementById("targetCount").value = 1;
        document.getElementById("usePity").checked = true;
        document.getElementById("pityCount").value = 90;
        togglePity();
        document.getElementById("result").textContent = "ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.";

        if (window.myChart) {
            window.myChart.destroy();
            window.myChart = null;
        }

        ["boxPrice","itemProb","totalDraws","targetCount","pityCount"].forEach(id=>{
            document.getElementById(id).classList.remove("error");
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        togglePity();
        // Enterë¡œ ê³„ì‚°
        ["boxPrice","itemProb","totalDraws","targetCount","pityCount"].forEach(id=>{
            const el = document.getElementById(id);
            el.addEventListener("keydown", (e)=>{ if(e.key==="Enter") itemCalculate(); });
        });
    });
</script>
</body>
</html>
