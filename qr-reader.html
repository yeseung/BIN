<!-- qr-reader.html (Vanilla JS + Clean CSS) -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR 코드 리더 - 이미지/붙여넣기/드래그/화면캡처</title>
    <style>
        :root{
            --bg:#f4f5f7;
            --card:#ffffff;
            --text:#111827;
            --muted:#6b7280;
            --line:#e5e7eb;
            --primary:#2563eb;
            --primary2:#1d4ed8;
            --danger:#ef4444;
            --danger2:#dc2626;
            --chip:#f9fafb;
            --shadow:0 10px 28px rgba(15,23,42,.08);
            --radius:18px;
        }
        *{ box-sizing:border-box; }
        body{
            margin:0; padding:24px;
            font-family:-apple-system,BlinkMacSystemFont,"Malgun Gothic",system-ui,sans-serif;
            background:var(--bg); color:var(--text);
        }
        .page{ max-width:1100px; margin:0 auto; }
        h1{ margin:0 0 8px; font-size:26px; font-weight:900; letter-spacing:-.2px; }
        .subtitle{ margin:0 0 18px; color:var(--muted); font-size:14px; line-height:1.7; }

        .grid{
            display:grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, .9fr);
            gap:16px;
            align-items:start;
        }
        .card{
            background:var(--card);
            border-radius:var(--radius);
            box-shadow:var(--shadow);
            padding:18px 20px 20px;
        }
        .section-title{
            margin:0 0 12px;
            font-weight:900;
            font-size:16px;
            letter-spacing:-.2px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:10px;
        }
        .badge{
            font-size:12px;
            color:#1f2937;
            background:#eef2ff;
            border:1px solid #e0e7ff;
            padding:6px 10px;
            border-radius:999px;
            font-weight:800;
            white-space:nowrap;
        }

        .dropzone{
            border:2px dashed #cbd5e1;
            border-radius:16px;
            background:#f9fafb;
            min-height:240px;
            display:flex;
            align-items:center;
            justify-content:center;
            text-align:center;
            padding:18px;
            color:#374151;
            user-select:none;
            transition: background .15s, border-color .15s, transform .05s;
            position:relative;
            overflow:hidden;
        }
        .dropzone.dragover{
            background:#eef2ff;
            border-color:#93c5fd;
        }
        .dropzone .hint{
            max-width:520px;
            font-size:14px;
            line-height:1.7;
            color:#374151;
        }
        .dropzone .hint small{
            display:block;
            margin-top:8px;
            color:var(--muted);
            font-size:12px;
        }
        .preview-wrap{
            width:100%;
            display:flex;
            flex-direction:column;
            gap:10px;
            align-items:center;
            justify-content:center;
        }
        .preview-img{
            max-width:100%;
            max-height:320px;
            border-radius:14px;
            border:1px solid var(--line);
            box-shadow:0 10px 26px rgba(15,23,42,.10);
            background:#fff;
        }
        .preview-meta{
            font-size:12px;
            color:var(--muted);
            width:100%;
            display:flex;
            justify-content:space-between;
            gap:10px;
            flex-wrap:wrap;
        }

        .actions{
            display:flex;
            flex-wrap:wrap;
            gap:8px;
            margin-top:12px;
        }
        .btn{
            border:0;
            border-radius:999px;
            padding:10px 14px;
            font-size:13px;
            cursor:pointer;
            background:#e5e7eb;
            color:#374151;
            transition:background .15s, transform .05s;
            white-space:nowrap;
            display:inline-flex;
            align-items:center;
            gap:8px;
            font-weight:800;
        }
        .btn:hover{ background:#d1d5db; }
        .btn:active{ transform:translateY(1px); }
        .btn.primary{ background:var(--primary); color:#fff; }
        .btn.primary:hover{ background:var(--primary2); }
        .btn.danger{ background:var(--danger); color:#fff; }
        .btn.danger:hover{ background:var(--danger2); }
        .btn.ghost{ background:#f3f4f6; }
        .btn:disabled{
            opacity:.55;
            cursor:not-allowed;
            transform:none;
        }
        .file-label{
            display:inline-flex;
            align-items:center;
            gap:8px;
            border-radius:999px;
            padding:10px 14px;
            font-size:13px;
            background:#f3f4f6;
            border:1px solid var(--line);
            cursor:pointer;
            font-weight:800;
            color:#374151;
        }
        .file-label:hover{ background:#e5e7eb; }

        .output{
            border:1px solid var(--line);
            border-radius:16px;
            background:#fff;
            padding:14px;
            min-height:170px;
            box-shadow:var(--shadow);
        }
        .output-head{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:10px;
            margin-bottom:10px;
        }
        .output-title{
            font-weight:900;
            letter-spacing:-.2px;
            margin:0;
            font-size:15px;
        }
        .status{
            font-size:12px;
            padding:6px 10px;
            border-radius:999px;
            border:1px solid var(--line);
            background:#f9fafb;
            color:#374151;
            font-weight:800;
            white-space:nowrap;
        }
        .status.ok{ background:#ecfdf5; border-color:#a7f3d0; color:#065f46; }
        .status.err{ background:#fef2f2; border-color:#fecaca; color:#991b1b; }
        .status.wait{ background:#eff6ff; border-color:#bfdbfe; color:#1e40af; }

        textarea.result{
            width:100%;
            min-height:110px;
            border-radius:12px;
            border:1px solid var(--line);
            background:#f9fafb;
            padding:10px 12px;
            outline:none;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "SF Mono", monospace;
            font-size:13px;
            line-height:1.6;
            resize:vertical;
        }
        textarea.result:focus{
            border-color:var(--primary);
            box-shadow:0 0 0 1px rgba(37,99,235,.15);
            background:#fff;
        }

        .mini{
            margin-top:10px;
            color:var(--muted);
            font-size:12px;
            line-height:1.6;
        }

        /* hidden canvas for processing */
        canvas{ display:none; }

        @media (max-width: 900px){
            .grid{ grid-template-columns: 1fr; }
            .actions .btn, .file-label{ flex:1; justify-content:center; }
            .dropzone{ min-height:210px; }
        }
    </style>
</head>
<body>
<div class="page">
    <h1>이미지 속 QR 코드 읽기</h1>
    <p class="subtitle">
        이미지 업로드 / Ctrl+V 붙여넣기 / 드래그 앤 드롭 / 화면 캡처(스크린 공유)로 QR 코드를 읽습니다.
    </p>

    <div class="grid">
        <!-- Left -->
        <div class="card">
            <div class="section-title">
                입력
                <span class="badge">이미지 기반 QR 리더</span>
            </div>

            <div id="pasteArea" class="dropzone" contenteditable="true" aria-label="이미지 붙여넣기 영역">
                <div class="hint">
                    여기에 <b>Ctrl+V</b>로 이미지를 붙여넣거나<br/>
                    이미지를 <b>드래그</b>해서 놓거나<br/>
                    아래 버튼으로 <b>업로드</b> / <b>화면 캡처</b>를 사용하세요.
                    <small>※ 모바일 브라우저는 붙여넣기/캡처 지원이 제한될 수 있습니다.</small>
                </div>
            </div>

            <input type="file" id="fileInput" accept="image/*" style="display:none;">

            <div class="actions">
                <label class="file-label" for="fileInput">이미지 파일 업로드</label>
                <button class="btn ghost" id="captureBtn" type="button">화면 캡처로 QR 읽기</button>
                <button class="btn primary" id="readBtn" type="button" disabled>현재 이미지 다시 읽기</button>
            </div>

            <p class="mini">
                팁: 화면 캡처는 브라우저가 “화면 공유” 권한을 요청합니다. 캡처 후 <b>정지</b>하면 자동으로 처리합니다.
            </p>
        </div>

        <!-- Right -->
        <div class="output">
            <div class="output-head">
                <p class="output-title">QR 결과</p>
                <span class="status wait" id="status">대기중</span>
            </div>

            <textarea id="output" class="result" readonly>QR 코드 결과가 여기에 표시됩니다.</textarea>

            <div class="actions">
                <button class="btn primary" id="copyBtn" type="button">Copy</button>
                <button class="btn danger" id="clearBtn" type="button">Clear</button>
            </div>

            <div class="mini" id="meta">-</div>
        </div>
    </div>
</div>

<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
    const output = document.getElementById('output');
    const statusEl = document.getElementById('status');
    const metaEl = document.getElementById('meta');

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    const pasteArea = document.getElementById('pasteArea');
    const fileInput = document.getElementById('fileInput');

    const captureBtn = document.getElementById('captureBtn');
    const copyBtn = document.getElementById('copyBtn');
    const clearBtn = document.getElementById('clearBtn');
    const readBtn = document.getElementById('readBtn');

    let lastImageBitmap = null; // 마지막 처리 이미지(재읽기용)
    let lastSourceLabel = '';

    function setStatus(kind, text){
        statusEl.className = 'status ' + kind;
        statusEl.textContent = text;
    }

    function setOutput(text){
        output.value = text;
    }

    function humanSize(bytes){
        if (!bytes && bytes !== 0) return '-';
        const units = ['B','KB','MB','GB'];
        let i = 0, v = bytes;
        while(v >= 1024 && i < units.length-1){ v/=1024; i++; }
        return (i===0 ? v : v.toFixed(1)) + ' ' + units[i];
    }

    // 이미지(비트맵)를 캔버스에 그리고 QR 읽기
    async function readQRFromBitmap(bitmap, sourceLabel = ''){
        try{
            setStatus('wait', '분석중…');
            lastImageBitmap = bitmap;
            lastSourceLabel = sourceLabel || 'image';
            readBtn.disabled = false;

            // 큰 이미지는 너무 무거울 수 있어 적당히 다운스케일(최대 1400px)
            const MAX = 1400;
            let w = bitmap.width;
            let h = bitmap.height;
            const scale = Math.min(1, MAX / Math.max(w, h));
            const dw = Math.max(1, Math.round(w * scale));
            const dh = Math.max(1, Math.round(h * scale));

            canvas.width = dw;
            canvas.height = dh;

            ctx.clearRect(0,0,dw,dh);
            ctx.drawImage(bitmap, 0, 0, dw, dh);

            const imageData = ctx.getImageData(0, 0, dw, dh);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if(code && code.data){
                setStatus('ok', '감지됨');
                setOutput(code.data);
            }else{
                setStatus('err', '미감지');
                setOutput("QR 코드가 감지되지 않았습니다.");
            }

            metaEl.textContent = `- 소스: ${lastSourceLabel} / 해상도: ${dw}×${dh} (원본 ${w}×${h})`;
            renderPreview(bitmap);

        }catch(err){
            console.error(err);
            setStatus('err', '오류');
            setOutput('처리 중 오류가 발생했습니다.');
            metaEl.textContent = '-';
        }
    }

    // 드롭존에 미리보기 표시
    function renderPreview(bitmap){
        pasteArea.innerHTML = '';
        pasteArea.contentEditable = "true";

        const wrap = document.createElement('div');
        wrap.className = 'preview-wrap';

        const img = document.createElement('img');
        img.className = 'preview-img';
        img.alt = '업로드된 이미지 미리보기';
        img.src = canvas.toDataURL('image/png');

        const meta = document.createElement('div');
        meta.className = 'preview-meta';
        meta.innerHTML = `<span>미리보기</span><span>${bitmap.width}×${bitmap.height}</span>`;

        wrap.appendChild(img);
        wrap.appendChild(meta);
        pasteArea.appendChild(wrap);
    }

    async function readFromFile(file, label){
        if(!file || !file.type.startsWith('image/')) return;
        try{
            const bitmap = await createImageBitmap(file);
            await readQRFromBitmap(bitmap, label || `파일: ${file.name} (${humanSize(file.size)})`);
        }catch(err){
            console.error(err);
            setStatus('err', '오류');
            setOutput("이미지 파일을 읽을 수 없습니다.");
        }
    }

    // 1) 파일 업로드
    fileInput.addEventListener('change', (e)=>{
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        readFromFile(file, `업로드: ${file.name} (${humanSize(file.size)})`);
        // 같은 파일 다시 선택 가능하도록 초기화
        fileInput.value = '';
    });

    // 2) 붙여넣기(이미지)
    pasteArea.addEventListener('paste', async (e)=>{
        const items = e.clipboardData && e.clipboardData.items;
        if(!items) return;

        for(const item of items){
            if(item.type && item.type.indexOf('image') !== -1){
                const file = item.getAsFile();
                if(file){
                    e.preventDefault();
                    await readFromFile(file, `붙여넣기: clipboard (${humanSize(file.size)})`);
                    return;
                }
            }
        }
    });

    // 3) 드래그 앤 드롭
    pasteArea.addEventListener('dragover', (e)=>{
        e.preventDefault();
        pasteArea.classList.add('dragover');
    });
    pasteArea.addEventListener('dragleave', ()=>{
        pasteArea.classList.remove('dragover');
    });
    pasteArea.addEventListener('drop', async (e)=>{
        e.preventDefault();
        pasteArea.classList.remove('dragover');

        const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if(file && file.type.startsWith('image/')){
            await readFromFile(file, `드롭: ${file.name} (${humanSize(file.size)})`);
        }
    });

    // 4) 화면 캡처(스크린샷 한 프레임)
    captureBtn.addEventListener('click', async ()=>{
        try{
            setStatus('wait', '캡처 대기…');
            setOutput('화면을 선택한 뒤 QR이 보이도록 한 프레임을 캡처합니다.');
            metaEl.textContent = '-';

            // 일부 브라우저는 HTTPS 필요
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });

            const video = document.createElement('video');
            video.srcObject = stream;

            await video.play();

            // 메타데이터 로드 대기
            await new Promise(resolve=>{
                if(video.readyState >= 2) return resolve();
                video.onloadedmetadata = resolve;
            });

            // 한 프레임 캡처
            const vw = video.videoWidth || 1280;
            const vh = video.videoHeight || 720;

            canvas.width = vw;
            canvas.height = vh;
            ctx.drawImage(video, 0, 0, vw, vh);

            // stream stop (사용자 화면 공유 종료)
            stream.getTracks().forEach(t => t.stop());

            // 캔버스 -> 비트맵
            const blob = await new Promise(res=> canvas.toBlob(res, 'image/png'));
            if(!blob){
                setStatus('err', '오류');
                setOutput("캡처 이미지를 만들 수 없습니다.");
                return;
            }
            const bitmap = await createImageBitmap(blob);
            await readQRFromBitmap(bitmap, '화면 캡처');

        }catch(err){
            console.error(err);
            setStatus('err', '거부됨');
            setOutput("화면 캡처가 허용되지 않았습니다.");
            metaEl.textContent = '-';
        }
    });

    // 재읽기
    readBtn.addEventListener('click', async ()=>{
        if(!lastImageBitmap) return;
        await readQRFromBitmap(lastImageBitmap, lastSourceLabel + ' (재읽기)');
    });

    // Copy
    copyBtn.addEventListener('click', async ()=>{
        const text = (output.value || '').trim();
        if(!text || text === "QR 코드 결과가 여기에 표시됩니다." || text === "QR 코드가 감지되지 않았습니다."){
            alert("복사할 QR 코드 결과가 없습니다.");
            return;
        }
        try{
            await navigator.clipboard.writeText(text);
            alert("복사되었습니다:\n" + text);
        }catch(err){
            alert("복사 실패: " + err);
        }
    });

    // Clear
    clearBtn.addEventListener('click', ()=>{
        setStatus('wait', '대기중');
        setOutput("QR 코드 결과가 여기에 표시됩니다.");
        metaEl.textContent = '-';

        lastImageBitmap = null;
        lastSourceLabel = '';
        readBtn.disabled = true;

        pasteArea.innerHTML = `
        <div class="hint">
          여기에 <b>Ctrl+V</b>로 이미지를 붙여넣거나<br/>
          이미지를 <b>드래그</b>해서 놓거나<br/>
          아래 버튼으로 <b>업로드</b> / <b>화면 캡처</b>를 사용하세요.
          <small>※ 모바일 브라우저는 붙여넣기/캡처 지원이 제한될 수 있습니다.</small>
        </div>
      `;
        canvas.width = 1;
        canvas.height = 1;
        ctx.clearRect(0,0,1,1);
    });

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
        setStatus('wait', '대기중');
        readBtn.disabled = true;
        canvas.width = 1;
        canvas.height = 1;
    });
</script>
</body>
</html>
