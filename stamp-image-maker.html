<!-- File: stamp-image-maker.html -->
<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stamp Image Maker</title>
    <meta name="description" content="ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ë‹¤ì–‘í•œ ë„ì¥ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. íˆ¬ëª… ë°°ê²½ PNG, ë³µì‚¬/ë‹¤ìš´ë¡œë“œ ì§€ì›." />

    <!-- ê¸°ë³¸ í•œê¸€ í°íŠ¸ (ëª…ì¡°/ê³ ë”•) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&family=Noto+Sans+KR:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root{
            --bg:#f6f7fb;
            --card:#ffffff;
            --text:#111827;
            --muted:#6b7280;

            --line:#e6e8f0;
            --shadow:0 14px 40px rgba(17,24,39,.10);

            --accent:#2c5aa0;
            --accent2:#7c3aed;

            --glass: rgba(255,255,255,.72);
            --glass-line: rgba(255,255,255,.55);

            --tip-bg:#eaf6f2;
            --tip-line:#c8eadf;

            --warn-bg:#fff6dc;
            --warn-line:#ffe2a8;

            --radius:18px;
        }

        *{ box-sizing:border-box; }
        body{
            margin:0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .wrap{
            max-width: 980px;
            margin: 0 auto;
            padding: 26px 16px 48px;
        }

        h4{
            margin: 0 0 8px;
            font-size: 24px;
            letter-spacing: -0.3px;
        }

        p{
            margin: 0 0 14px;
            color: var(--muted);
            line-height: 1.6;
        }

        /* white main panel (optional) */
        .panel{
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
        }

        /* Info / Warning boxes */
        .info-box{
            margin-top: 14px;
            background: var(--tip-bg);
            border: 1px solid var(--tip-line);
            border-radius: 14px;
            padding: 16px 18px;
        }
        .info-box h5{
            margin:0 0 10px;
            font-size: 15px;
            font-weight: 800;
            color: #0f766e;
            display:flex;
            align-items:center;
            gap:8px;
        }
        .info-box ul{
            margin: 0;
            padding-left: 18px;
            color:#134e4a;
            font-size: 14px;
        }
        .info-box li{ margin: 6px 0; }

        .warning-box{
            margin-top: 14px;
            background: var(--warn-bg);
            border: 1px solid var(--warn-line);
            border-radius: 14px;
            padding: 14px 16px;
        }

        /* Glass card (input + gallery container) */
        .glass-card{
            margin-top: 14px;
            padding: 18px;
            border-radius: var(--radius);
            border: 1px solid rgba(17,24,39,.08);
            background: linear-gradient(180deg, rgba(255,255,255,.86), rgba(255,255,255,.70));
            box-shadow: 0 12px 30px rgba(17,24,39,.08);
            backdrop-filter: blur(10px);
        }

        /* Inputs */
        .form-input{
            width: 100%;
            border-radius: 14px;
            border: 1px solid rgba(17,24,39,.14);
            background: #fff;
            padding: 12px 12px;
            font-size: 14px;
            outline: none;
            transition: box-shadow .15s ease, border-color .15s ease;
        }
        .form-input:focus{
            border-color: rgba(124,58,237,.35);
            box-shadow: 0 0 0 4px rgba(124,58,237,.12);
        }
        .form-input.error{
            border-color: rgba(239,68,68,.55);
            box-shadow: 0 0 0 4px rgba(239,68,68,.10);
        }
        .form-input.success{
            border-color: rgba(34,197,94,.55);
            box-shadow: 0 0 0 4px rgba(34,197,94,.10);
        }

        /* Buttons */
        .glass-button{
            appearance:none;
            border: 1px solid rgba(124,58,237,.25);
            background: linear-gradient(135deg, #7c3aed, #2563eb);
            color: #fff;
            font-weight: 800;
            font-size: 14px;
            padding: 11px 16px;
            border-radius: 14px;
            cursor:pointer;
            box-shadow: 0 10px 20px rgba(37,99,235,.14);
            transition: transform .08s ease, filter .15s ease;
        }
        .glass-button:hover{ transform: translateY(-1px); filter: brightness(1.03); }
        .glass-button:active{ transform: translateY(0); }

        /* Error message */
        .error-message{
            display:none;
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(239,68,68,.25);
            background: rgba(239,68,68,.06);
            color: #b91c1c;
            font-size: 13px;
            font-weight: 700;
        }

        /* Gallery */
        .stamp-gallery{
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
        }
        @media (max-width: 900px){
            .stamp-gallery{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        @media (max-width: 560px){
            .stamp-gallery{ grid-template-columns: 1fr; }
        }

        .category-title{
            grid-column: 1 / -1;
            margin-top: 8px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(17,24,39,.08);
            background: #f7f8ff;
            color: #111827;
            font-weight: 900;
            letter-spacing: -0.2px;
        }

        .subcategory-title{
            grid-column: 1 / -1;
            display:flex;
            align-items:flex-start;
            justify-content: space-between;
            gap: 10px;
            margin-top: 6px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(17,24,39,.08);
            background: #fbfcff;
            color: #1f2937;
            font-weight: 900;
            letter-spacing: -0.2px;
            flex-wrap: wrap;
        }

        .adjust-controls{
            display:flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items:center;
            justify-content: flex-end;
        }
        .adjust-group{
            display:flex;
            align-items:center;
            gap: 6px;
            padding: 6px 8px;
            border: 1px solid rgba(17,24,39,.08);
            border-radius: 12px;
            background: #ffffff;
        }
        .adjust-group label{
            font-size: 12px;
            color: var(--muted);
            font-weight: 800;
        }
        .adjust-btn{
            width: 30px;
            height: 30px;
            border-radius: 10px;
            border: 1px solid rgba(17,24,39,.10);
            background: #f3f4f6;
            cursor:pointer;
            font-weight: 900;
            color:#374151;
            transition: transform .08s ease, background .15s ease;
            line-height: 1;
        }
        .adjust-btn:hover{ background:#eef2ff; transform: translateY(-1px); }
        .adjust-btn:active{ transform: translateY(0); }

        /* Stamp item */
        .stamp-item{
            border: 1px solid rgba(17,24,39,.08);
            border-radius: 16px;
            background: #ffffff;
            padding: 12px;
            box-shadow: 0 10px 22px rgba(17,24,39,.06);
            display:flex;
            flex-direction: column;
            align-items:center;
            gap: 10px;
        }
        .stamp-item canvas{
            width: 200px;
            height: 200px;
            border-radius: 12px;
            background: repeating-conic-gradient(from 45deg, rgba(0,0,0,.025) 0 10deg, rgba(0,0,0,0) 10deg 20deg);
            border: 1px solid rgba(17,24,39,.08);
        }
        .stamp-item-label{
            text-align:center;
            font-size: 12px;
            color:#374151;
            font-weight: 800;
            line-height: 1.35;
            padding: 0 4px;
            word-break: keep-all;
        }
        .stamp-item-actions{
            display:flex;
            gap: 8px;
            width: 100%;
            justify-content:center;
        }

        .btn-download, .btn-copy{
            appearance:none;
            border-radius: 12px;
            padding: 9px 12px;
            font-weight: 900;
            font-size: 12px;
            cursor:pointer;
            border: 1px solid rgba(17,24,39,.10);
            transition: transform .08s ease, background .15s ease, border-color .15s ease;
            min-width: 92px;
        }
        .btn-download{
            background: #eef2ff;
            border-color: rgba(124,58,237,.18);
            color:#3730a3;
        }
        .btn-copy{
            background: #ecfeff;
            border-color: rgba(14,116,144,.18);
            color:#0e7490;
        }
        .btn-download:hover, .btn-copy:hover{
            transform: translateY(-1px);
            border-color: rgba(17,24,39,.18);
        }
        .btn-download:active, .btn-copy:active{ transform: translateY(0); }
    </style>
</head>

<body>
<div class="wrap">
    <div class="panel">
        <h4><b>ë„ì¥ ì´ë¯¸ì§€ ë§Œë“¤ê¸° (Stamp Image Maker)</b></h4>
        <p style="font-size:14px;">
            ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ì—¬ëŸ¬ ê°€ì§€ ë„ì¥ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. íˆ¬ëª…í•œ ë°°ê²½ì´ë©°, ë‹¤ì–‘í•œ ê¸€ì”¨ì²´ì™€ ìŠ¤íƒ€ì¼ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            ëª¨ë‘ ë¬´ë£Œì´ë©° íšŒì›ê°€ì…, ë¡œê·¸ì¸, ì´ë©”ì¼ ìˆ˜ì§‘ ì—†ì´ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </p>

        <div class="info-box">
            <h5>ğŸ“‹ ì‚¬ìš© ë°©ë²•</h5>
            <ul>
                <li>ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ë‹¤ì–‘í•œ í˜•íƒœì˜ ë„ì¥ ì´ë¯¸ì§€ê°€ ìƒì„±ë©ë‹ˆë‹¤.</li>
                <li>ë„ì¥ ì´ë¯¸ì§€ëŠ” íˆ¬ëª… ë°°ê²½ì´ë©°, í´ë¦½ë³´ë“œ ë³µì‚¬, ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                <li>ì´ë¦„ì€ 2~4ì ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
            </ul>
        </div>

        <div class="glass-card">
            <div style="margin: 10px 0;">
                <label for="nameInput" style="display:block; margin-bottom: 6px; font-weight: 900;">
                    ì´ë¦„ <span style="color: #ef4444;">*</span>
                </label>
                <input type="text" id="nameInput" class="form-input" placeholder="ì˜ˆ: í™ê¸¸ë™ ë˜ëŠ” æ´ªå‰æ± ì…ë ¥" maxlength="4">
                <small style="color:#6b7280; font-size: 11px; display:block; margin-top: 6px;">
                    â€» í•œê¸€ ë˜ëŠ” í•œìë¡œ ì…ë ¥í•˜ì„¸ìš” (2~4ì).
                </small>
            </div>

            <div style="text-align:center; margin: 18px 0 0; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                <button onclick="generateAllStamps()" class="glass-button">ğŸ” ë„ì¥ ì´ë¯¸ì§€ ë§Œë“¤ê¸°</button>
                <button onclick="resetAllAdjustments()" class="glass-button" style="background: linear-gradient(135deg, #6B7280, #4B5563); border-color: rgba(107,114,128,.35);">
                    ğŸ”„ ì´ˆê¸°í™”
                </button>
            </div>
        </div>

        <div id="error-message" class="error-message"></div>

        <div id="stamp-gallery-container" class="glass-card" style="display:none;">
            <h5 style="color: var(--accent); margin: 0 0 14px; font-size: 18px; font-weight: 900; text-align:center;">
                ğŸ“Š ë„ì¥ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬
            </h5>
            <div id="stamp-gallery" class="stamp-gallery"></div>
        </div>

        <div class="warning-box">
            <p style="margin:0; font-size: 13px; color:#856404;">
                <strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong> ì´ ë„êµ¬ëŠ” ê°œì¸ì ì¸ ìš©ë„ë¡œ ì‚¬ìš©í•˜ëŠ” ë„ì¥ ì´ë¯¸ì§€ë¥¼ ë§Œë“­ë‹ˆë‹¤.
                ê³µì‹ ë¬¸ì„œë‚˜ ë²•ì  íš¨ë ¥ì´ í•„ìš”í•œ ìš©ë„ë¡œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </p>
        </div>
    </div>
</div>

<script>
    // ë„ì¥ ì„¤ì •
    const STAMP_CONFIG = {
        size: 200, // ê¸°ë³¸ í¬ê¸° (ì‹¤ì œ ë„ì¥ í¬ê¸°ì— ê°€ê¹ê²Œ)
        stampColor: '#DC143C', // ì§„í•œ ë¹¨ê°„ìƒ‰ (ì¸ì£¼ìƒ‰)
        backgroundColor: 'transparent'
    };

    // ê¸€ì”¨ì²´ ì˜µì…˜ (ê¸°ë³¸: ëª…ì¡°, ê³ ë”•, ê¶ì„œì²´, í•œì»´í›ˆë¯¼ì •ìŒ, í•œê¸€ì¬ë¯¼, ë…ë¦½)
    const FONT_STYLES = [
        { id: 'myeongjo', name: 'ëª…ì¡°ì²´', font: "'Nanum Myeongjo', serif", weight: '700' },
        { id: 'gothic', name: 'ê³ ë”•ì²´', font: "'Noto Sans KR', sans-serif", weight: '400' },
        { id: 'gungseo', name: 'ê¶ì„œì²´', font: "'DeokongPrincess', serif", weight: '400' },
        { id: 'hancom', name: 'í•œì»´í›ˆë¯¼ì •ìŒ', font: "'HancomHunminjeongeum', serif", weight: '400' },
        { id: 'jaemin', name: 'í•œê¸€ì¬ë¯¼', font: "'HangulJaemin30', serif", weight: '400' },
        { id: 'independent', name: 'ë…ë¦½', font: "'Independent', serif", weight: '400' }
    ];

    // ë„ì¥ ìŠ¤íƒ€ì¼ ì˜µì…˜ (ì–‘ê°, ìŒê°ë§Œ)
    const STAMP_STYLES = [
        { id: 'raised', name: 'ì–‘ê°' },
        { id: 'engraved', name: 'ìŒê°' }
    ];

    // ê° ìœ í˜•ë³„ ì¡°ì •ê°’ ì €ì¥ (í˜•íƒœ-ìŠ¤íƒ€ì¼ì„ í‚¤ë¡œ ì‚¬ìš©)
    const adjustmentSettings = {};

    // ê° ìœ í˜•ë³„ ë„ì¥ ê·¸ë£¹ ì €ì¥ (ì¬ê·¸ë¦¬ê¸°ìš©)
    const stampGroups = {};

    // í•œê¸€/í•œì íŒë‹¨
    function containsHanja(text) {
        const hanjaPattern = /[\u4E00-\u9FFF]/;
        return hanjaPattern.test(text);
    }

    // ì´ë¦„ì— "ì¸" ì¶”ê°€
    function formatNameWithIn(name) {
        if (!name || name.trim() === '') return '';
        const trimmed = name.trim();
        if (containsHanja(trimmed)) {
            return trimmed + 'å°';
        }
        return trimmed + 'ì¸';
    }

    // ì´ë¦„ì„ ë¶„í•  (ì›í˜• ë„ì¥ìš©)
    function splitNameForCircle(name) {
        const trimmed = name.trim();
        const nameLength = trimmed.length;

        // 2ê¸€ì: ì¸ ì—†ì´ í•œ ì¤„ ì¤‘ê°„ ë°°ì¹˜
        if (nameLength === 2) {
            return { top: trimmed, bottom: '', isSingleLine: true, originalLength: 2 };
        }
        // 3ê¸€ì: ì¸ ì¶”ê°€í•´ì„œ 4ê¸€ì (ìœ„ 2ê¸€ì, ì•„ë˜ 2ê¸€ì)
        else if (nameLength === 3) {
            const isHanja = containsHanja(trimmed);
            if (isHanja) {
                return {
                    top: trimmed.substring(2, 3) + trimmed.substring(0, 1),  // 3,1
                    bottom: 'å°' + trimmed.substring(1, 2),                  // å°,2
                    isSingleLine: false,
                    originalLength: 3
                };
            } else {
                const withIn = formatNameWithIn(trimmed);
                return {
                    top: withIn.substring(0, 2),
                    bottom: withIn.substring(2, 4),
                    isSingleLine: false,
                    originalLength: 3
                };
            }
        }
        // 4ê¸€ì: ì¸ ì—†ì´ 4ê¸€ì ê·¸ëŒ€ë¡œ (ìœ„ 2ê¸€ì, ì•„ë˜ 2ê¸€ì)
        else if (nameLength === 4) {
            return {
                top: trimmed.substring(0, 2),
                bottom: trimmed.substring(2, 4),
                isSingleLine: false,
                originalLength: 4
            };
        }
        // ê¸°ë³¸ê°’
        else {
            return {
                top: trimmed.substring(0, 2) || '',
                bottom: trimmed.substring(2, 4) || '',
                isSingleLine: false,
                originalLength: nameLength
            };
        }
    }

    // ì´ë¦„ì„ ë¶„í•  (íƒ€ì›í˜• ë„ì¥ìš© - ì¸ ì œì™¸)
    function splitNameForOval(name) {
        const trimmed = name.trim();
        const nameLength = trimmed.length;

        if (nameLength === 2) {
            return { chars: [trimmed.substring(0, 1), trimmed.substring(1, 2)], shouldSkip: false };
        } else if (nameLength === 3) {
            return {
                chars: [trimmed.substring(0, 1), trimmed.substring(1, 2), trimmed.substring(2, 3)],
                shouldSkip: false
            };
        } else if (nameLength === 4) {
            return { chars: [], shouldSkip: true };
        } else {
            return { chars: trimmed.split('').slice(0, 3), shouldSkip: false };
        }
    }

    // Canvas ê³ í•´ìƒë„ ì„¤ì •
    function setupHighDPICanvas(canvas, size) {
        const dpr = window.devicePixelRatio || 1;
        const displaySize = size;

        canvas.width = displaySize * dpr;
        canvas.height = displaySize * dpr;
        canvas.style.width = displaySize + 'px';
        canvas.style.height = displaySize + 'px';

        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        ctx.scale(dpr, dpr);
        return ctx;
    }

    // ì…ë ¥ê°’ ê²€ì¦
    function validateInput() {
        const nameInput = document.getElementById('nameInput');
        const name = nameInput.value.trim();

        if (!name || name === '') {
            showError('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            nameInput.classList.add('error');
            nameInput.classList.remove('success');
            return false;
        }

        if (name.length < 2 || name.length > 4) {
            showError('ì´ë¦„ì€ 2ê¸€ìì—ì„œ 4ê¸€ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            nameInput.classList.add('error');
            nameInput.classList.remove('success');
            return false;
        }

        nameInput.classList.remove('error');
        nameInput.classList.add('success');
        hideError();
        return true;
    }

    // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    // ì˜¤ë¥˜ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
    function hideError() {
        document.getElementById('error-message').style.display = 'none';
    }

    // ì›í˜• ë„ì¥ ê·¸ë¦¬ê¸°
    function drawCircleStamp(canvas, nameParts, fontStyle, stampStyle, adjustments = {}) {
        const ctx = setupHighDPICanvas(canvas, STAMP_CONFIG.size);
        const size = STAMP_CONFIG.size;

        ctx.clearRect(0, 0, size, size);

        const centerX = size / 2;
        const centerY = size / 2;
        const radius = size / 2 - 20;

        ctx.save();

        if (stampStyle === 'engraved') {
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
            ctx.fillStyle = STAMP_CONFIG.stampColor;
            ctx.fill();
        }

        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
        ctx.strokeStyle = STAMP_CONFIG.stampColor;
        ctx.lineWidth = 4;
        ctx.stroke();

        const fontConfig = FONT_STYLES.find(f => f.id === fontStyle) || FONT_STYLES[0];
        const baseFontSize = fontStyle === 'gungseo' ? 70 : 60;
        const fontSize = baseFontSize + (adjustments.fontSize || 0);

        let fontFamily = fontConfig.font.replace(/'/g, '');
        ctx.font = `${fontConfig.weight} ${fontSize}px ${fontFamily}`;
        ctx.fillStyle = stampStyle === 'engraved' ? '#FFFFFF' : STAMP_CONFIG.stampColor;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const letterSpacing = adjustments.letterSpacing || 0;
        const lineSpacingMultiplier = 0.5 + (adjustments.lineSpacing || 0) / 100;

        if (nameParts.isSingleLine && nameParts.originalLength === 2) {
            const baseHorizontalSpacing = radius * 0.3;
            const horizontalSpacing = baseHorizontalSpacing + letterSpacing;
            ctx.fillText(nameParts.top[0] || '', centerX - horizontalSpacing, centerY);
            ctx.fillText(nameParts.top[1] || '', centerX + horizontalSpacing, centerY);
        } else {
            const lineSpacing = fontSize * lineSpacingMultiplier;
            const topY = centerY - lineSpacing;
            const bottomY = centerY + lineSpacing;

            const baseHorizontalSpacing = radius * 0.35;
            const horizontalSpacing = baseHorizontalSpacing + letterSpacing;

            ctx.fillText(nameParts.top[0] || '', centerX - horizontalSpacing, topY);
            ctx.fillText(nameParts.top[1] || '', centerX + horizontalSpacing, topY);
            ctx.fillText(nameParts.bottom[0] || '', centerX - horizontalSpacing, bottomY);
            ctx.fillText(nameParts.bottom[1] || '', centerX + horizontalSpacing, bottomY);
        }

        ctx.restore();
        addTextureEffect(ctx, size, size, stampStyle);
    }

    // íƒ€ì›í˜• ë„ì¥ ê·¸ë¦¬ê¸°
    function drawOvalStamp(canvas, nameChars, fontStyle, stampStyle, adjustments = {}) {
        const ctx = setupHighDPICanvas(canvas, STAMP_CONFIG.size);
        const size = STAMP_CONFIG.size;

        ctx.clearRect(0, 0, size, size);

        const centerX = size / 2;
        const centerY = size / 2;
        const width = size * 0.6;
        const height = size * 0.8;

        ctx.save();

        if (stampStyle === 'engraved') {
            ctx.beginPath();
            ctx.ellipse(centerX, centerY, width / 2, height / 2, 0, 0, Math.PI * 2);
            ctx.fillStyle = STAMP_CONFIG.stampColor;
            ctx.fill();
        }

        ctx.beginPath();
        ctx.ellipse(centerX, centerY, width / 2, height / 2, 0, 0, Math.PI * 2);
        ctx.strokeStyle = STAMP_CONFIG.stampColor;
        ctx.lineWidth = 4;
        ctx.stroke();

        const fontConfig = FONT_STYLES.find(f => f.id === fontStyle) || FONT_STYLES[0];
        const baseFontSize = 54;
        const fontSize = baseFontSize + (adjustments.fontSize || 0);

        let fontFamily = fontConfig.font.replace(/'/g, '');
        ctx.font = `${fontConfig.weight} ${fontSize}px ${fontFamily}`;

        ctx.fillStyle = stampStyle === 'engraved' ? '#FFFFFF' : STAMP_CONFIG.stampColor;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const lineSpacingMultiplier = 3.3 - (adjustments.lineSpacing || 0) / 10;
        const letterSpacing = adjustments.letterSpacing || 0;

        const charCount = nameChars.chars.length;
        if (charCount === 2) {
            const spacing = height / lineSpacingMultiplier;
            ctx.fillText(nameChars.chars[0] || '', centerX + letterSpacing, centerY - spacing / 2);
            ctx.fillText(nameChars.chars[1] || '', centerX + letterSpacing, centerY + spacing / 2);
        } else if (charCount === 3) {
            const spacing = height / lineSpacingMultiplier;
            ctx.fillText(nameChars.chars[0] || '', centerX + letterSpacing, centerY - spacing);
            ctx.fillText(nameChars.chars[1] || '', centerX + letterSpacing, centerY);
            ctx.fillText(nameChars.chars[2] || '', centerX + letterSpacing, centerY + spacing);
        }

        ctx.restore();
        addTextureEffect(ctx, size, size, stampStyle);
    }

    // ì‚¬ê°í˜• ë„ì¥ ê·¸ë¦¬ê¸°
    function drawSquareStamp(canvas, nameParts, fontStyle, stampStyle, adjustments = {}) {
        const ctx = setupHighDPICanvas(canvas, STAMP_CONFIG.size);
        const size = STAMP_CONFIG.size;

        ctx.clearRect(0, 0, size, size);

        const centerX = size / 2;
        const centerY = size / 2;
        const squareSize = size - 50;
        const squareX = centerX - squareSize / 2;
        const squareY = centerY - squareSize / 2;

        ctx.save();

        if (stampStyle === 'engraved') {
            ctx.fillStyle = STAMP_CONFIG.stampColor;
            ctx.fillRect(squareX, squareY, squareSize, squareSize);
        }

        ctx.beginPath();
        ctx.rect(squareX, squareY, squareSize, squareSize);
        ctx.strokeStyle = STAMP_CONFIG.stampColor;
        ctx.lineWidth = 4;
        ctx.stroke();

        const fontConfig = FONT_STYLES.find(f => f.id === fontStyle) || FONT_STYLES[0];
        const baseFontSize = fontStyle === 'gungseo' ? 70 : 60;
        const fontSize = baseFontSize + (adjustments.fontSize || 0);

        let fontFamily = fontConfig.font.replace(/'/g, '');
        ctx.font = `${fontConfig.weight} ${fontSize}px ${fontFamily}`;

        ctx.fillStyle = stampStyle === 'engraved' ? '#FFFFFF' : STAMP_CONFIG.stampColor;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const letterSpacing = adjustments.letterSpacing || 0;
        const lineSpacingMultiplier = 0.45 + (adjustments.lineSpacing || 0) / 100;

        if (nameParts.isSingleLine && nameParts.originalLength === 2) {
            const baseHorizontalSpacing = squareSize * 0.18;
            const horizontalSpacing = baseHorizontalSpacing + letterSpacing;
            ctx.fillText(nameParts.top[0] || '', centerX - horizontalSpacing, centerY);
            ctx.fillText(nameParts.top[1] || '', centerX + horizontalSpacing, centerY);
        } else {
            const lineSpacing = fontSize * lineSpacingMultiplier;
            const topY = centerY - lineSpacing;
            const bottomY = centerY + lineSpacing;

            const baseHorizontalSpacing = squareSize * 0.18;
            const horizontalSpacing = baseHorizontalSpacing + letterSpacing;

            ctx.fillText(nameParts.top[0] || '', centerX - horizontalSpacing, topY);
            ctx.fillText(nameParts.top[1] || '', centerX + horizontalSpacing, topY);
            ctx.fillText(nameParts.bottom[0] || '', centerX - horizontalSpacing, bottomY);
            ctx.fillText(nameParts.bottom[1] || '', centerX + horizontalSpacing, bottomY);
        }

        ctx.restore();
        addTextureEffect(ctx, size, size, stampStyle);
    }

    // í…ìŠ¤ì²˜ íš¨ê³¼ ì¶”ê°€
    function addTextureEffect(ctx, width, height, style) {
        ctx.save();

        const imageData = ctx.getImageData(0, 0, width, height);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
            if (data[i + 3] > 0) {
                const noise = (Math.random() - 0.5) * 8;
                data[i] = Math.max(0, Math.min(255, data[i] + noise));
                data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + noise));
                data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + noise));
            }
        }

        ctx.putImageData(imageData, 0, 0);
        ctx.restore();
    }

    // ì¹´í…Œê³ ë¦¬ ì œëª© ìƒì„±
    function createCategoryTitle(text) {
        const title = document.createElement('div');
        title.className = 'category-title';
        title.textContent = text;
        return title;
    }

    // ì„œë¸Œì¹´í…Œê³ ë¦¬ ì œëª© ìƒì„± (ì¡°ì • ë²„íŠ¼ í¬í•¨)
    function createSubcategoryTitle(text, typeKey, redrawCallback) {
        const container = document.createElement('div');
        container.className = 'subcategory-title';

        const titleText = document.createElement('span');
        titleText.textContent = text;
        container.appendChild(titleText);

        if (!adjustmentSettings[typeKey]) {
            adjustmentSettings[typeKey] = { fontSize: 0, letterSpacing: 0, lineSpacing: 0 };
        }

        const controls = document.createElement('div');
        controls.className = 'adjust-controls';

        const fontSizeGroup = createAdjustGroup('ê¸€ìí¬ê¸°', typeKey, 'fontSize', redrawCallback);
        const letterSpacingGroup = createAdjustGroup('ìê°„', typeKey, 'letterSpacing', redrawCallback);
        const lineSpacingGroup = createAdjustGroup('ì¤„ê°„ê²©', typeKey, 'lineSpacing', redrawCallback);

        controls.appendChild(fontSizeGroup);
        controls.appendChild(letterSpacingGroup);
        controls.appendChild(lineSpacingGroup);

        container.appendChild(controls);
        return container;
    }

    // ì¡°ì • ê·¸ë£¹ ìƒì„±
    function createAdjustGroup(label, typeKey, adjustType, redrawCallback) {
        const group = document.createElement('div');
        group.className = 'adjust-group';

        const labelEl = document.createElement('label');
        labelEl.textContent = label;
        group.appendChild(labelEl);

        const decreaseBtn = document.createElement('button');
        decreaseBtn.className = 'adjust-btn';
        decreaseBtn.type = 'button';
        decreaseBtn.textContent = 'âˆ’';
        decreaseBtn.onclick = () => adjustValue(typeKey, adjustType, -1, redrawCallback);

        const increaseBtn = document.createElement('button');
        increaseBtn.className = 'adjust-btn';
        increaseBtn.type = 'button';
        increaseBtn.textContent = '+';
        increaseBtn.onclick = () => adjustValue(typeKey, adjustType, 1, redrawCallback);

        group.appendChild(decreaseBtn);
        group.appendChild(increaseBtn);
        return group;
    }

    // ì¡°ì •ê°’ ë³€ê²½ ë° ì¬ê·¸ë¦¬ê¸°
    function adjustValue(typeKey, adjustType, delta, redrawCallback) {
        if (!adjustmentSettings[typeKey]) {
            adjustmentSettings[typeKey] = { fontSize: 0, letterSpacing: 0, lineSpacing: 0 };
        }

        const limits = {
            fontSize: { min: -20, max: 20 },
            letterSpacing: { min: -10, max: 10 },
            lineSpacing: { min: -30, max: 30 }
        };

        const limit = limits[adjustType];
        adjustmentSettings[typeKey][adjustType] = Math.max(
            limit.min,
            Math.min(limit.max, adjustmentSettings[typeKey][adjustType] + delta)
        );

        if (redrawCallback) redrawCallback(typeKey, adjustmentSettings[typeKey]);
    }

    // ëª¨ë“  ì¡°ì •ê°’ ì´ˆê¸°í™” ë° ì™„ì „ ì´ˆê¸° ìƒíƒœë¡œ ë³µì›
    function resetAllAdjustments() {
        Object.keys(adjustmentSettings).forEach(key => {
            adjustmentSettings[key] = { fontSize: 0, letterSpacing: 0, lineSpacing: 0 };
        });

        Object.keys(stampGroups).forEach(key => delete stampGroups[key]);

        const nameInput = document.getElementById('nameInput');
        nameInput.value = '';
        nameInput.classList.remove('error', 'success');

        const galleryContainer = document.getElementById('stamp-gallery-container');
        galleryContainer.style.display = 'none';

        const gallery = document.getElementById('stamp-gallery');
        gallery.innerHTML = '';

        hideError();
    }

    // í°íŠ¸ ë¡œë“œ í™•ì¸ ë° ëŒ€ê¸°
    async function ensureFontsLoaded() {
        try {
            await document.fonts.ready;

            const deokongLoaded = document.fonts.check('1em DeokongPrincess');
            if (!deokongLoaded) {
                const deokongFont = new FontFace('DeokongPrincess',
                    'url(https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2205@1.0/DeogonPrincess.woff2)');
                await deokongFont.load();
                document.fonts.add(deokongFont);
            }

            const hancomLoaded = document.fonts.check('1em HancomHunminjeongeum');
            if (!hancomLoaded) {
                const hancomFont = new FontFace('HancomHunminjeongeum',
                    'url(https://cdn.jsdelivr.net/gh/projectnoonnu/2406-1@1.0/HancomHoonminjeongeumH.woff)');
                await hancomFont.load();
                document.fonts.add(hancomFont);
            }

            const jaeminLoaded = document.fonts.check('1em HangulJaemin30');
            if (!jaeminLoaded) {
                const jaeminFont = new FontFace('HangulJaemin30',
                    'url(https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2307-1@1.1/Hangeuljaemin4-Regular.woff2)');
                await jaeminFont.load();
                document.fonts.add(jaeminFont);
            }

            const independentLoaded = document.fonts.check('1em Independent');
            if (!independentLoaded) {
                const independentFont = new FontFace('Independent',
                    'url(https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_twelve@1.1/Dokrip.woff)');
                await independentFont.load();
                document.fonts.add(independentFont);
            }

            return true;
        } catch (error) {
            console.warn('í°íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            return false;
        }
    }

    // ëª¨ë“  ë„ì¥ ìƒì„±
    async function generateAllStamps() {
        if (!validateInput()) return;

        await ensureFontsLoaded();

        const name = document.getElementById('nameInput').value.trim();
        const gallery = document.getElementById('stamp-gallery');
        gallery.innerHTML = '';

        Object.keys(stampGroups).forEach(key => delete stampGroups[key]);

        const nameParts = splitNameForCircle(name);
        const nameChars = splitNameForOval(name);
        const nameLength = name.trim().length;

        // 1) ì›í˜•
        gallery.appendChild(createCategoryTitle('1) ì›í˜•'));

        // 1-1) ì›í˜•-ì–‘ê°
        const typeKey1 = 'circle-raised';
        const group1 = { items: [], nameParts, stampStyle: 'raised', drawFunc: drawCircleStamp };
        const redrawCallback1 = (typeKey, adjustments) => {
            group1.items.forEach(item => {
                drawCircleStamp(item.canvas, item.nameParts, item.fontStyle, item.stampStyle, adjustments);
            });
        };
        gallery.appendChild(createSubcategoryTitle('1-1) ì›í˜• - ì–‘ê°', typeKey1, redrawCallback1));
        FONT_STYLES.forEach(fontStyle => {
            const canvas = document.createElement('canvas');
            const adjustments = adjustmentSettings[typeKey1] || {};
            drawCircleStamp(canvas, nameParts, fontStyle.id, 'raised', adjustments);
            const item = createStampItem(canvas, `ì›í˜• - ì–‘ê° - ${fontStyle.name}`, name);
            gallery.appendChild(item);
            group1.items.push({ canvas, nameParts, fontStyle: fontStyle.id, stampStyle: 'raised' });
        });
        stampGroups[typeKey1] = group1;

        // 1-2) ì›í˜•-ìŒê°
        const typeKey2 = 'circle-engraved';
        const group2 = { items: [], nameParts, stampStyle: 'engraved', drawFunc: drawCircleStamp };
        const redrawCallback2 = (typeKey, adjustments) => {
            group2.items.forEach(item => {
                drawCircleStamp(item.canvas, item.nameParts, item.fontStyle, item.stampStyle, adjustments);
            });
        };
        gallery.appendChild(createSubcategoryTitle('1-2) ì›í˜• - ìŒê°', typeKey2, redrawCallback2));
        FONT_STYLES.forEach(fontStyle => {
            const canvas = document.createElement('canvas');
            const adjustments = adjustmentSettings[typeKey2] || {};
            drawCircleStamp(canvas, nameParts, fontStyle.id, 'engraved', adjustments);
            const item = createStampItem(canvas, `ì›í˜• - ìŒê° - ${fontStyle.name}`, name);
            gallery.appendChild(item);
            group2.items.push({ canvas, nameParts, fontStyle: fontStyle.id, stampStyle: 'engraved' });
        });
        stampGroups[typeKey2] = group2;

        // 2) íƒ€ì›í˜• (4ê¸€ìì¼ ë•Œ ì œì™¸)
        if (nameLength !== 4 && !nameChars.shouldSkip) {
            gallery.appendChild(createCategoryTitle('2) íƒ€ì›í˜•'));

            // 2-1) íƒ€ì›í˜•-ì–‘ê°
            const typeKey3 = 'oval-raised';
            const group3 = { items: [], nameChars, stampStyle: 'raised', drawFunc: drawOvalStamp };
            const redrawCallback3 = (typeKey, adjustments) => {
                group3.items.forEach(item => {
                    drawOvalStamp(item.canvas, item.nameChars, item.fontStyle, item.stampStyle, adjustments);
                });
            };
            gallery.appendChild(createSubcategoryTitle('2-1) íƒ€ì›í˜• - ì–‘ê°', typeKey3, redrawCallback3));
            FONT_STYLES.forEach(fontStyle => {
                const canvas = document.createElement('canvas');
                const adjustments = adjustmentSettings[typeKey3] || {};
                drawOvalStamp(canvas, nameChars, fontStyle.id, 'raised', adjustments);
                const item = createStampItem(canvas, `íƒ€ì›í˜• - ì–‘ê° - ${fontStyle.name}`, name);
                gallery.appendChild(item);
                group3.items.push({ canvas, nameChars, fontStyle: fontStyle.id, stampStyle: 'raised' });
            });
            stampGroups[typeKey3] = group3;

            // 2-2) íƒ€ì›í˜•-ìŒê°
            const typeKey4 = 'oval-engraved';
            const group4 = { items: [], nameChars, stampStyle: 'engraved', drawFunc: drawOvalStamp };
            const redrawCallback4 = (typeKey, adjustments) => {
                group4.items.forEach(item => {
                    drawOvalStamp(item.canvas, item.nameChars, item.fontStyle, item.stampStyle, adjustments);
                });
            };
            gallery.appendChild(createSubcategoryTitle('2-2) íƒ€ì›í˜• - ìŒê°', typeKey4, redrawCallback4));
            FONT_STYLES.forEach(fontStyle => {
                const canvas = document.createElement('canvas');
                const adjustments = adjustmentSettings[typeKey4] || {};
                drawOvalStamp(canvas, nameChars, fontStyle.id, 'engraved', adjustments);
                const item = createStampItem(canvas, `íƒ€ì›í˜• - ìŒê° - ${fontStyle.name}`, name);
                gallery.appendChild(item);
                group4.items.push({ canvas, nameChars, fontStyle: fontStyle.id, stampStyle: 'engraved' });
            });
            stampGroups[typeKey4] = group4;
        }

        // 3) ì‚¬ê°í˜•
        gallery.appendChild(createCategoryTitle('3) ì‚¬ê°í˜•'));

        // 3-1) ì‚¬ê°í˜•-ì–‘ê°
        const typeKey5 = 'square-raised';
        const group5 = { items: [], nameParts, stampStyle: 'raised', drawFunc: drawSquareStamp };
        const redrawCallback5 = (typeKey, adjustments) => {
            group5.items.forEach(item => {
                drawSquareStamp(item.canvas, item.nameParts, item.fontStyle, item.stampStyle, adjustments);
            });
        };
        gallery.appendChild(createSubcategoryTitle('3-1) ì‚¬ê°í˜• - ì–‘ê°', typeKey5, redrawCallback5));
        FONT_STYLES.forEach(fontStyle => {
            const canvas = document.createElement('canvas');
            const adjustments = adjustmentSettings[typeKey5] || {};
            drawSquareStamp(canvas, nameParts, fontStyle.id, 'raised', adjustments);
            const item = createStampItem(canvas, `ì‚¬ê°í˜• - ì–‘ê° - ${fontStyle.name}`, name);
            gallery.appendChild(item);
            group5.items.push({ canvas, nameParts, fontStyle: fontStyle.id, stampStyle: 'raised' });
        });
        stampGroups[typeKey5] = group5;

        // 3-2) ì‚¬ê°í˜•-ìŒê°
        const typeKey6 = 'square-engraved';
        const group6 = { items: [], nameParts, stampStyle: 'engraved', drawFunc: drawSquareStamp };
        const redrawCallback6 = (typeKey, adjustments) => {
            group6.items.forEach(item => {
                drawSquareStamp(item.canvas, item.nameParts, item.fontStyle, item.stampStyle, adjustments);
            });
        };
        gallery.appendChild(createSubcategoryTitle('3-2) ì‚¬ê°í˜• - ìŒê°', typeKey6, redrawCallback6));
        FONT_STYLES.forEach(fontStyle => {
            const canvas = document.createElement('canvas');
            const adjustments = adjustmentSettings[typeKey6] || {};
            drawSquareStamp(canvas, nameParts, fontStyle.id, 'engraved', adjustments);
            const item = createStampItem(canvas, `ì‚¬ê°í˜• - ìŒê° - ${fontStyle.name}`, name);
            gallery.appendChild(item);
            group6.items.push({ canvas, nameParts, fontStyle: fontStyle.id, stampStyle: 'engraved' });
        });
        stampGroups[typeKey6] = group6;

        document.getElementById('stamp-gallery-container').style.display = 'block';
        document.getElementById('stamp-gallery-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ë„ì¥ ì•„ì´í…œ ìƒì„±
    function createStampItem(canvas, label, name) {
        const item = document.createElement('div');
        item.className = 'stamp-item';

        const labelDiv = document.createElement('div');
        labelDiv.className = 'stamp-item-label';
        labelDiv.textContent = label;

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'stamp-item-actions';

        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'btn-download';
        downloadBtn.type = 'button';
        downloadBtn.textContent = 'Down';
        downloadBtn.onclick = () => downloadStampCanvas(canvas, name, label);

        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn-copy';
        copyBtn.type = 'button';
        copyBtn.textContent = 'Copy';
        copyBtn.onclick = () => copyCanvasToClipboard(canvas, copyBtn);

        actionsDiv.appendChild(downloadBtn);
        actionsDiv.appendChild(copyBtn);

        item.appendChild(canvas);
        item.appendChild(labelDiv);
        item.appendChild(actionsDiv);

        return item;
    }

    // ë„ì¥ ë‹¤ìš´ë¡œë“œ
    function downloadStampCanvas(canvas, name, label) {
        const link = document.createElement('a');
        link.download = `${name}_${label.replace(/\s+/g, '_')}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    }

    // í´ë¦½ë³´ë“œ ë³µì‚¬
    async function copyCanvasToClipboard(canvas, button) {
        try {
            const blob = await new Promise(resolve => {
                canvas.toBlob(resolve, 'image/png', 1.0);
            });
            await navigator.clipboard.write([
                new ClipboardItem({ 'image/png': blob })
            ]);

            const originalText = button.textContent;
            button.textContent = 'Copied';
            button.disabled = true;

            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 2000);
        } catch (err) {
            showError('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì˜¤ë¥˜:', err);
        }
    }

    // ì‹¤ì‹œê°„ ì…ë ¥ ê²€ì¦
    document.addEventListener('DOMContentLoaded', function() {
        const nameInput = document.getElementById('nameInput');

        nameInput.addEventListener('input', function() {
            const name = this.value.trim();
            if (name === '') {
                this.classList.remove('error', 'success');
            } else if (name.length > 10) {
                this.classList.add('error');
                this.classList.remove('success');
            } else {
                this.classList.remove('error');
                this.classList.add('success');
            }
        });

        nameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') generateAllStamps();
        });
    });
</script>
</body>
</html>
