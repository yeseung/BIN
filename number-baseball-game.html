<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Number Baseball Game | ìˆ«ì ì•¼êµ¬ ê²Œì„</title>
    <meta name="description" content="ì¤‘ë³µ ì—†ëŠ” ìˆ«ìë¡œ ì»´í“¨í„°ê°€ ë§Œë“  ì •ë‹µì„ ë§ì¶”ëŠ” ìˆ«ì ì•¼êµ¬(Strike/Ball) ê²Œì„. ë‚œì´ë„(3/4/5ìë¦¬), OUT ì‹œìŠ¤í…œ, ê²Œì„ ë¡œê·¸, ë­í‚¹(ëª¨ì˜/ì‹¤ì„œë²„) ì§€ì›." />

    <style>
        :root{
            --bg1:#f5f7fb;
            --bg2:#eef3ff;
            --card: rgba(255,255,255,.72);
            --stroke: rgba(44,90,160,.22);
            --text:#111827;
            --muted:#4b5563;
            --blue:#2563eb;
            --blue2:#1e40af;
            --green:#16a34a;
            --red:#dc2626;
            --amber:#f59e0b;
            --shadow: 0 18px 45px rgba(17,24,39,.12);
            --radius: 14px;
        }

        *{ box-sizing:border-box; }
        body{
            margin:0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Malgun Gothic", Arial, sans-serif;
            color: var(--text);
            background:
                    radial-gradient(1200px 800px at 20% 10%, #dbeafe 0%, transparent 55%),
                    radial-gradient(900px 700px at 80% 20%, #e9d5ff 0%, transparent 55%),
                    linear-gradient(180deg, var(--bg1), var(--bg2));
            min-height:100vh;
        }

        .wrap{
            max-width: 980px;
            margin: 22px auto 60px;
            padding: 0 14px;
        }

        .text-center{ text-align:center; }
        .mb-8{ margin-bottom: 18px; }
        .mb-6{ margin-bottom: 14px; }
        .mb-4{ margin-bottom: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }
        .mt-4{ margin-top: 10px; }

        /* Tailwind-ish helpers you used */
        .hidden{ display:none !important; }
        .text-2xl{ font-size: 22px; }
        .text-3xl{ font-size: 28px; }
        .text-xl{ font-size: 18px; }
        .text-lg{ font-size: 16px; }
        .font-bold{ font-weight: 900; }
        .font-semibold{ font-weight: 800; }
        .text-gray-900{ color: #111827; }
        .text-gray-700{ color: #374151; }
        .text-sm{ font-size: 13px; }
        .text-base{ font-size: 15px; }
        .leading-relaxed{ line-height: 1.6; }
        .text-blue-600{ color: var(--blue); }
        .font-medium{ font-weight: 700; }
        .mx-auto{ margin-left:auto; margin-right:auto; }
        .rounded-lg{ border-radius: 14px; }
        .shadow-lg{ box-shadow: 0 18px 45px rgba(17,24,39,.12); }
        .p-6{ padding: 16px; }
        .w-full{ width: 100%; }
        .flex{ display:flex; }
        .gap-4{ gap: 10px; }
        .flex-1{ flex:1; }
        .sm\:w-auto{}
        .sm\:px-8{}
        .sm\:py-4{}

        .glass-card{
            background: var(--card);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 16px;
            margin: 14px 0;
        }

        .glass-button{
            border: 1px solid var(--stroke);
            background: rgba(255,255,255,.7);
            color: #0f172a;
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 900;
            cursor: pointer;
            transition: .15s ease;
            box-shadow: 0 12px 24px rgba(17,24,39,.10);
            user-select: none;
        }
        .glass-button:hover{ transform: translateY(-1px); }
        .glass-button:active{ transform: translateY(0px); }

        .radio-group{
            display:flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 8px 0 2px;
        }
        .radio-group input[type="radio"]{
            position:absolute;
            opacity:0;
            pointer-events:none;
        }
        .radio-group label{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            padding: 10px 12px;
            border-radius: 12px;
            border: 2px solid rgba(59,130,246,.22);
            background: rgba(255,255,255,.65);
            cursor:pointer;
            font-weight: 900;
            transition:.15s ease;
            user-select:none;
        }
        .radio-group input[type="radio"]:checked + label{
            border-color: rgba(37,99,235,.65);
            background: rgba(37,99,235,.10);
            box-shadow: 0 0 0 4px rgba(37,99,235,.10);
        }

        .ranking-container{
            max-height: 360px;
            overflow:auto;
            padding-right: 4px;
        }

        /* Game area */
        .baseball-area{
            position: relative;
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid rgba(59,130,246,.18);
            background: rgba(255,255,255,.55);
        }

        .out-counter{
            position:absolute;
            top: 12px;
            right: 12px;
            display:flex;
            align-items:center;
            gap: 8px;
            padding: 8px 10px;
            background: rgba(255,255,255,.75);
            border: 1px solid rgba(59,130,246,.18);
            border-radius: 999px;
            box-shadow: 0 10px 22px rgba(17,24,39,.10);
        }
        .out-label{
            font-weight: 900;
            font-size: 12px;
            color: #ef4444;
            letter-spacing: .5px;
        }
        .out-circle{
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: rgba(251,146,60,.18); /* ì—°í•œ ë‹¤í™ */
            border: 2px solid rgba(251,146,60,.35);
        }
        .out-circle.lost{
            background: rgba(239,68,68,.85);
            border-color: rgba(239,68,68,.75);
            box-shadow: 0 0 0 3px rgba(239,68,68,.12);
        }

        .baseball-input{
            width:100%;
            padding: 12px 12px;
            border-radius: 12px;
            border: 2px solid rgba(59,130,246,.25);
            background: rgba(255,255,255,.75);
            font-size: 16px;
            font-weight: 900;
            letter-spacing: 3px;
            text-align:center;
            outline:none;
            transition:.15s ease;
        }
        .baseball-input:focus{
            border-color: rgba(37,99,235,.70);
            box-shadow: 0 0 0 4px rgba(37,99,235,.12);
        }

        .submit-button{
            background: linear-gradient(135deg, rgba(16,185,129,.95), rgba(5,150,105,.95));
            border-color: rgba(16,185,129,.55);
            color: white;
            padding: 12px 14px;
            min-width: 140px;
        }

        .result-display{
            display:flex;
            justify-content:center;
            gap: 10px;
            margin: 10px 0 14px;
            transition: .2s ease;
        }
        .strike-ball-item{
            flex: 0 0 160px;
            padding: 12px 12px;
            border-radius: 14px;
            border: 1px solid rgba(59,130,246,.18);
            background: rgba(255,255,255,.75);
            box-shadow: 0 12px 24px rgba(17,24,39,.10);
            text-align:center;
        }
        .strike-item{ border-color: rgba(34,197,94,.35); }
        .ball-item{ border-color: rgba(245,158,11,.35); }
        .strike-ball-label{
            font-weight: 900;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px;
            letter-spacing:.3px;
        }
        .strike-ball-value{
            font-size: 28px;
            font-weight: 1000;
            color: #111827;
        }

        .game-log{
            margin-top: 12px;
            max-height: 280px;
            overflow:auto;
            background: rgba(255,255,255,.65);
            border: 1px solid rgba(59,130,246,.18);
            border-radius: 14px;
            padding: 10px;
        }

        .log-entry{
            display:flex;
            gap: 10px;
            align-items:center;
            padding: 8px 10px;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(0,0,0,.06);
            background: rgba(255,255,255,.65);
        }
        .log-entry.strike-ball{
            border-color: rgba(59,130,246,.18);
            background: rgba(59,130,246,.06);
        }
        .log-entry.out{
            border-color: rgba(239,68,68,.22);
            background: rgba(239,68,68,.06);
        }
        .log-entry.success{
            border-color: rgba(16,185,129,.25);
            background: rgba(16,185,129,.08);
            justify-content:center;
        }
        .log-entry.game-over{
            border-color: rgba(220,38,38,.25);
            background: rgba(220,38,38,.08);
            justify-content:center;
        }

        .log-number{
            font-weight: 1000;
            color: #0f172a;
            min-width: 44px;
        }
        .log-guess{
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-weight: 1000;
            letter-spacing: 2px;
            min-width: 90px;
            text-align:center;
        }
        .log-result{
            font-weight: 900;
            color: var(--blue2);
        }
        .log-out{
            font-weight: 1000;
            color: var(--red);
            text-transform: uppercase;
        }
        .log-success{
            font-weight: 1000;
            color: var(--green);
        }
        .log-game-over{
            font-weight: 1000;
            color: var(--red);
        }

        /* Toast */
        .toast-container{
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 20000;
            display:flex;
            flex-direction: column;
            gap: 10px;
            max-width: 360px;
        }
        .toast{
            background: rgba(255,255,255,.92);
            border: 1px solid rgba(17,24,39,.12);
            border-radius: 14px;
            box-shadow: 0 18px 45px rgba(17,24,39,.18);
            transform: translateX(110%);
            opacity: 0;
            transition: .35s ease;
            overflow:hidden;
        }
        .toast.show{
            transform: translateX(0%);
            opacity: 1;
        }
        .toast .toast-content{
            display:flex;
            align-items:flex-start;
            gap: 10px;
            padding: 12px 12px;
        }
        .toast-icon{
            font-size: 18px;
            line-height: 1;
            margin-top: 2px;
        }
        .toast-message{
            font-size: 13px;
            line-height: 1.45;
            color: #0f172a;
            font-weight: 800;
            flex:1;
            word-break: keep-all;
        }
        .toast-close{
            border:0;
            background: transparent;
            font-size: 18px;
            cursor: pointer;
            color: rgba(15,23,42,.65);
            font-weight: 900;
            line-height: 1;
            padding: 0 2px;
        }
        .toast.error{ border-color: rgba(220,38,38,.25); }
        .toast.warning{ border-color: rgba(245,158,11,.25); }
        .toast.success{ border-color: rgba(16,185,129,.25); }
        .toast.info{ border-color: rgba(59,130,246,.25); }

        @keyframes shake{
            0%,100%{ transform: translateX(0); }
            20%{ transform: translateX(-6px); }
            40%{ transform: translateX(6px); }
            60%{ transform: translateX(-4px); }
            80%{ transform: translateX(4px); }
        }
        .toast.shake{ animation: shake .35s ease; }

        /* Small responsive tweaks */
        @media (max-width: 560px){
            .strike-ball-item{ flex-basis: 140px; }
            .submit-button{ min-width: 120px; }
        }
    </style>
</head>

<body>
<div class="wrap">
    <div class="text-center mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-4">âš¾ ìˆ«ì ì•¼êµ¬ ê²Œì„</h1>
        <p class="text-gray-700 text-sm sm:text-base leading-relaxed">
            ì»´í“¨í„°ê°€ ìƒê°í•œ ìˆ«ìë¥¼ ë§ì¶°ë³´ì„¸ìš”!<br class="hidden sm:block">
            StrikeëŠ” ìë¦¬ì™€ ìˆ«ìê°€ ëª¨ë‘ ë§ëŠ” ê²½ìš°, Ballì€ ìˆ«ìë§Œ ë§ëŠ” ê²½ìš°ì…ë‹ˆë‹¤.<br class="hidden sm:block">
            <span class="text-blue-600 font-medium">ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ìˆ«ìë¡œë§Œ êµ¬ì„±ë©ë‹ˆë‹¤.</span>
        </p>

        <div class="text-center mt-4 mb-6">
            <img decoding="async"
                 src="assets/img/medcalc-baseball.png"
                 alt="ì•¼êµ¬ ê²Œì„"
                 class="mx-auto rounded-lg shadow-lg"
                 style="max-width: 400px; max-height: 240px; object-fit: contain; opacity: 0.9;">
        </div>
    </div>

    <div id="setup-screen">
        <div class="glass-card rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">ê²Œì„ ì„¤ì •</h2>

            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">ë‚œì´ë„ ì„ íƒ</h3>
                <div class="radio-group">
                    <input type="radio" id="level-3" name="level" value="3" />
                    <label for="level-3">ğŸ¥ í•˜ (3ìë¦¬)</label>

                    <input type="radio" id="level-4" name="level" value="4" checked />
                    <label for="level-4">âš¾ ì¤‘ (4ìë¦¬)</label>

                    <input type="radio" id="level-5" name="level" value="5" />
                    <label for="level-5">ğŸŸï¸ ìƒ (5ìë¦¬)</label>
                </div>
            </div>

            <button id="start-btn" class="glass-button w-full px-8 py-4">ğŸš€ ê²Œì„ ì‹œì‘</button>
        </div>

        <div class="glass-card rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">ë­í‚¹ (ë‚œì´ë„ë³„ Top 100)</h2>
            <div id="ranking-list" class="ranking-container">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
        </div>
    </div>

    <div id="game-screen" class="hidden">
        <div class="glass-card baseball-area">
            <div id="out-counter" class="out-counter"></div>

            <h2 class="text-xl font-semibold text-gray-900 mb-4">ìˆ«ì ì•¼êµ¬ ê²Œì„</h2>

            <div id="result-display" class="result-display hidden">
                <div class="strike-ball-item strike-item">
                    <div class="strike-ball-label">Strike</div>
                    <div class="strike-ball-value" id="strike-count">0</div>
                </div>
                <div class="strike-ball-item ball-item">
                    <div class="strike-ball-label">Ball</div>
                    <div class="strike-ball-value" id="ball-count">0</div>
                </div>
            </div>

            <div class="mb-4">
                <div class="input-group flex gap-4">
                    <input type="text" id="guess-input" maxlength="5" autocomplete="off"
                           class="baseball-input flex-1" placeholder="ìˆ«ì ì…ë ¥" />
                    <button id="submit-btn" class="glass-button submit-button px-6 py-3">ğŸ¯ ìˆ«ì ì œì¶œ</button>
                </div>
            </div>

            <div id="log-area" class="game-log"></div>

            <div class="mt-4 text-center">
                <button id="reset-btn" class="glass-button w-full sm:w-auto sm:px-8 sm:py-4">ğŸ”„ ì²˜ìŒìœ¼ë¡œ</button>
            </div>
        </div>
    </div>
</div>

<script>
    (() => {
        const setupScreen   = document.getElementById('setup-screen');
        const gameScreen    = document.getElementById('game-screen');
        const startBtn      = document.getElementById('start-btn');
        const resetBtn      = document.getElementById('reset-btn');
        const guessInput    = document.getElementById('guess-input');
        const submitBtn     = document.getElementById('submit-btn');
        const outCounter    = document.getElementById('out-counter');
        const logArea       = document.getElementById('log-area');
        const rankingList   = document.getElementById('ranking-list');
        const resultDisplay = document.getElementById('result-display');
        const strikeCount   = document.getElementById('strike-count');
        const ballCount     = document.getElementById('ball-count');

        let level = 4;
        let maxOut = 3;
        let outCount = 0;
        let answer = [];
        let tries = 0;
        let gameEnded = false;

        function generateAnswer(digits) {
            const nums = [];
            while (nums.length < digits) {
                const n = Math.floor(Math.random() * 10);
                if (!nums.includes(n)) nums.push(n);
            }
            return nums;
        }

        function calcStrikeBall(guessArr, answerArr) {
            let strike = 0;
            let ball = 0;
            guessArr.forEach((num, i) => {
                if (num === answerArr[i]) strike++;
                else if (answerArr.includes(num)) ball++;
            });
            return { strike, ball };
        }

        function renderOutCounter() {
            outCounter.innerHTML = '';
            const label = document.createElement('span');
            label.className = 'out-label';
            label.textContent = 'OUT';
            outCounter.appendChild(label);

            for (let i = 0; i < maxOut; i++) {
                const circle = document.createElement('div');
                circle.className = 'out-circle';
                if (i < outCount) circle.classList.add('lost');
                outCounter.appendChild(circle);
            }
        }

        function showStrikeBallResult(strike, ball) {
            strikeCount.textContent = strike;
            ballCount.textContent = ball;
            resultDisplay.classList.remove('hidden');

            setTimeout(() => {
                resultDisplay.style.opacity = '0';
                resultDisplay.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    resultDisplay.style.opacity = '1';
                    resultDisplay.style.transform = 'scale(1)';
                }, 120);
            }, 2000);
        }

        function addLogEntry(type, content) {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;

            if (type === 'strike-ball') {
                const parts = content.split(' - ');
                logEntry.innerHTML = `
          <span class="log-number">${parts[0]}</span>
          <span class="log-guess">${parts[1]}</span>
          <span class="log-result">${parts[2]}</span>
        `;
            } else if (type === 'out') {
                const parts = content.split(' - ');
                logEntry.innerHTML = `
          <span class="log-number">${parts[0]}</span>
          <span class="log-guess">${parts[1]}</span>
          <span class="log-out">${parts[2]}</span>
        `;
            } else if (type === 'success') {
                logEntry.innerHTML = `<span class="log-success">${content}</span>`;
            } else if (type === 'game-over') {
                logEntry.innerHTML = `<span class="log-game-over">${content}</span>`;
            }

            logArea.insertBefore(logEntry, logArea.firstChild);
            logArea.scrollTop = 0;

            while (logArea.children.length > 10) {
                logArea.removeChild(logArea.lastChild);
            }
        }

        function formatTimestamp(timestamp, datetime) {
            if (datetime) {
                const date = new Date(datetime);
                return date.toLocaleString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                });
            }
            if (timestamp) {
                const date = new Date(timestamp * 1000);
                return date.toLocaleString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                });
            }
            return 'ë“±ë¡ì‹œê°„ ì—†ìŒ';
        }

        async function fetchRanking(level) {
            rankingList.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            try {
                const isLocal = (
                    window.location.hostname === 'localhost' ||
                    window.location.hostname === '127.0.0.1' ||
                    window.location.hostname === ''
                );

                if (isLocal) {
                    const mockData = {
                        3: [
                            {nickname: 'ì•¼êµ¬ì‹ ë™', tries: 2, timestamp: '2024-01-01 09:00'},
                            {nickname: 'ìˆ«ìì²œì¬', tries: 3, timestamp: '2024-01-01 09:15'},
                            {nickname: 'ê²Œì„ë§ˆìŠ¤í„°', tries: 3, timestamp: '2024-01-01 09:30'},
                            {nickname: 'ìŠ¤íŠ¸ë¼ì´í¬í‚¹', tries: 4, timestamp: '2024-01-01 10:00'},
                            {nickname: 'ë³¼ë§ˆìŠ¤í„°', tries: 4, timestamp: '2024-01-01 10:15'}
                        ],
                        4: [
                            {nickname: 'ì•¼êµ¬ì™•', tries: 3, timestamp: '2024-01-01 08:00'},
                            {nickname: 'ìˆ«ìë§ˆìŠ¤í„°', tries: 3, timestamp: '2024-01-01 08:30'},
                            {nickname: 'ê²Œì„ê³ ìˆ˜', tries: 4, timestamp: '2024-01-01 09:00'},
                            {nickname: 'ìŠ¤íŠ¸ë¼ì´í¬í‚¹', tries: 4, timestamp: '2024-01-01 09:30'},
                            {nickname: 'ë³¼ë§ˆìŠ¤í„°', tries: 5, timestamp: '2024-01-01 10:00'}
                        ],
                        5: [
                            {nickname: 'ì•¼êµ¬ì „ì„¤', tries: 4, timestamp: '2024-01-01 07:00'},
                            {nickname: 'ìˆ«ìì‹ ', tries: 4, timestamp: '2024-01-01 07:30'},
                            {nickname: 'ê²Œì„ê³ ìˆ˜', tries: 5, timestamp: '2024-01-01 08:00'},
                            {nickname: 'ìŠ¤íŠ¸ë¼ì´í¬í‚¹', tries: 5, timestamp: '2024-01-01 08:30'},
                            {nickname: 'ë³¼ë§ˆìŠ¤í„°', tries: 6, timestamp: '2024-01-01 09:00'}
                        ]
                    };

                    const currentLevelData = mockData[level] || mockData[4];
                    rankingList.innerHTML = '';
                    currentLevelData.forEach((item, idx) => {
                        const rank = idx + 1;
                        const isTop10 = rank <= 10;
                        const medal = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
                        const fontWeight = isTop10 ? 'bold' : 'normal';
                        const fontSize = isTop10 ? '16px' : '14px';
                        const background = isTop10 ? 'rgba(255,215,0,0.2)' : 'rgba(255,255,255,0.1)';
                        const border = isTop10 ? '2px solid rgba(255,215,0,0.5)' : '1px solid rgba(255,255,255,0.2)';

                        rankingList.innerHTML += `
              <div class="ranking-item" style="
                padding: 6px 12px;
                margin: 2px 0;
                background: ${background};
                border: ${border};
                border-radius: 8px;
                font-weight: ${fontWeight};
                font-size: ${fontSize};
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: all 0.3s ease;
              " onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'"
                 onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none'">
                <span>${medal} ${rank}. ${item.nickname}</span>
                <div style="text-align: right;">
                  <div style="color: #3B82F6; font-weight: bold;">${item.tries}íšŒ</div>
                  <div style="font-size: 11px; color: #666; margin-top: 2px;">${item.timestamp}</div>
                </div>
              </div>`;
                    });
                    return;
                }

                const res = await fetch(`/js/number-baseball-ranking-ko.php?level=${level}`);
                if (!res.ok) throw new Error('ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
                const data = await res.json();

                if (!data.length) {
                    rankingList.textContent = 'ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                    return;
                }

                rankingList.innerHTML = '';
                data.slice(0, 100).forEach((item, idx) => {
                    const rank = idx + 1;
                    const isTop10 = rank <= 10;
                    const medal = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
                    const fontWeight = isTop10 ? 'bold' : 'normal';
                    const fontSize = isTop10 ? '16px' : '14px';
                    const background = isTop10 ? 'rgba(255,215,0,0.2)' : 'rgba(255,255,255,0.1)';
                    const border = isTop10 ? '2px solid rgba(255,215,0,0.5)' : '1px solid rgba(255,255,255,0.2)';

                    rankingList.innerHTML += `
            <div class="ranking-item" style="
              padding: 6px 12px;
              margin: 2px 0;
              background: ${background};
              border: ${border};
              border-radius: 8px;
              font-weight: ${fontWeight};
              font-size: ${fontSize};
              display: flex;
              justify-content: space-between;
              align-items: center;
              transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'"
               onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none'">
              <span>${medal} ${rank}. ${item.nickname}</span>
              <div style="text-align: right;">
                <div style="color: #3B82F6; font-weight: bold;">${item.tries}íšŒ</div>
                <div style="font-size: 11px; color: #666; margin-top: 2px;">${formatTimestamp(item.timestamp, item.datetime)}</div>
              </div>
            </div>`;
                });
            } catch (e) {
                rankingList.textContent = 'ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” ëª¨ì˜ ë°ì´í„° í‘œì‹œ)';
            }
        }

        document.querySelectorAll('input[name=level]').forEach(radio => {
            radio.addEventListener('change', e => {
                level = Number(e.target.value);
                fetchRanking(level);
            });
        });

        startBtn.addEventListener('click', () => {
            level = Number(document.querySelector('input[name=level]:checked').value);
            answer = generateAnswer(level);
            outCount = 0;
            tries = 0;
            gameEnded = false;

            setupScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            guessInput.value = '';
            guessInput.maxLength = level;
            logArea.innerHTML = '';
            resultDisplay.classList.add('hidden');
            renderOutCounter();
            guessInput.focus();
            showSuccess(`ê²Œì„ ì‹œì‘! ${level}ìë¦¬ ìˆ«ìë¥¼ ë§ì¶°ë³´ì„¸ìš”!`);
        });

        submitBtn.addEventListener('click', () => {
            if (gameEnded) return;

            const guessStr = guessInput.value.trim();
            if (guessStr.length !== level) {
                showError(`${level}ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                return;
            }
            if (!/^\d+$/.test(guessStr)) {
                showError('ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            const guessArr = guessStr.split('').map(Number);
            const uniq = new Set(guessArr);
            if (uniq.size !== guessArr.length) {
                showError('ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            tries++;
            const { strike, ball } = calcStrikeBall(guessArr, answer);

            if (strike === 0 && ball === 0) {
                outCount++;
                renderOutCounter();
                addLogEntry('out', `#${tries} - ${guessStr} - ${outCount} out`);
                if (outCount >= maxOut) {
                    addLogEntry('game-over', `ê²Œì„ ì˜¤ë²„! ì •ë‹µì€ ${answer.join('')} ì…ë‹ˆë‹¤.`);
                    gameEnded = true;
                }
            } else {
                showStrikeBallResult(strike, ball);
                addLogEntry('strike-ball', `#${tries} - ${guessStr} - ${strike} strike, ${ball} ball`);
                if (strike === level) {
                    addLogEntry('success', `ì •ë‹µ! ì¶•í•˜í•©ë‹ˆë‹¤! (${tries}íšŒ ë§Œì— ì„±ê³µ)`);
                    gameEnded = true;
                    showRankingModal(level, tries);
                }
            }

            guessInput.value = '';
            guessInput.focus();
        });

        guessInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                submitBtn.click();
            }
        });

        resetBtn.addEventListener('click', () => {
            gameEnded = false;
            setupScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');
            rankingList.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            resultDisplay.classList.add('hidden');
            fetchRanking(level);
        });

        fetchRanking(level);

        // Toast
        function createToastContainer() {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            return container;
        }

        function showToast(message, type = 'info', duration = 4000) {
            const container = createToastContainer();
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = { error:'âŒ', warning:'âš ï¸', success:'âœ…', info:'â„¹ï¸' };

            toast.innerHTML = `
        <div class="toast-content">
          <span class="toast-icon">${icons[type] || icons.info}</span>
          <span class="toast-message">${message}</span>
          <button class="toast-close" type="button" aria-label="ë‹«ê¸°">Ã—</button>
        </div>
      `;

            toast.querySelector('.toast-close').addEventListener('click', () => removeToast(toast));
            container.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            if (type === 'error') setTimeout(() => toast.classList.add('shake'), 100);

            if (duration > 0) setTimeout(() => removeToast(toast), duration);
            return toast;
        }

        function removeToast(toast) {
            if (!toast || !toast.parentElement) return;
            toast.classList.remove('show');
            toast.style.transform = 'translateX(110%)';
            toast.style.opacity = '0';
            setTimeout(() => {
                if (toast.parentElement) toast.parentElement.removeChild(toast);
            }, 380);
        }

        function showError(message)   { return showToast(message, 'error', 5000); }
        function showSuccess(message) { return showToast(message, 'success', 3000); }

        // Ranking modal
        function injectModalAnimOnce(){
            if (document.getElementById('modal-animation')) return;
            const style = document.createElement('style');
            style.id = 'modal-animation';
            style.textContent = `
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes slideIn { from{transform:scale(.9) translateY(-30px);opacity:0} to{transform:scale(1) translateY(0);opacity:1} }
      `;
            document.head.appendChild(style);
        }

        function showRankingModal(level, tries) {
            const existingModal = document.getElementById('ranking-modal');
            if (existingModal) existingModal.remove();

            injectModalAnimOnce();

            const modal = document.createElement('div');
            modal.id = 'ranking-modal';
            modal.style.cssText = `
        position: fixed; inset: 0;
        background: rgba(0,0,0,.68);
        backdrop-filter: blur(6px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn .25s ease-out;
        padding: 18px;
      `;

            modal.innerHTML = `
        <div style="
          background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
          border-radius: 20px;
          padding: 26px;
          max-width: 520px;
          width: 100%;
          box-shadow: 0 20px 60px rgba(59, 130, 246, 0.3);
          border: 2px solid rgba(255, 255, 255, 0.2);
          animation: slideIn .25s ease-out;
        ">
          <div style="text-align:center; color:white;">
            <h2 style="font-size: 24px; font-weight: 1000; margin: 0 0 14px 0;">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</h2>
            <p style="font-size: 15px; margin: 0 0 14px 0; opacity: .92;">
              ${level}ìë¦¬ ìˆ«ìë¥¼ <b>${tries}íšŒ</b> ë§Œì— ë§ì¶”ì…¨ìŠµë‹ˆë‹¤!
            </p>

            <div style="background: rgba(255,255,255,.12); border-radius: 12px; padding: 16px; margin: 14px 0;">
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align:left; font-weight: 900;">
                <div>ë‚œì´ë„: ${level}ìë¦¬</div>
                <div>ì‹œë„: ${tries}íšŒ</div>
              </div>
            </div>

            <p style="font-size: 15px; margin: 0 0 12px 0;">ë­í‚¹ì— ì´ë¦„ì„ ì˜¬ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?</p>

            <div style="margin-bottom: 14px;">
              <input type="text" id="userNameInput"
                     placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 12ì)"
                     maxlength="12"
                     style="
                       width: 100%;
                       padding: 12px 14px;
                       border: 2px solid rgba(255,255,255,.35);
                       border-radius: 10px;
                       background: rgba(255,255,255,.92);
                       font-size: 15px;
                       color: #111;
                       outline: none;
                     ">
            </div>

            <div style="display:flex; gap: 10px; justify-content:center; flex-wrap: wrap;">
              <button id="registerBtn" type="button" style="
                background: linear-gradient(135deg, #22c55e, #16a34a);
                color: white;
                border: none;
                padding: 12px 18px;
                border-radius: 10px;
                font-size: 15px;
                font-weight: 1000;
                cursor: pointer;
                transition: .15s ease;
                box-shadow: 0 10px 22px rgba(34,197,94,.25);
              ">ë“±ë¡í•˜ê¸°</button>

              <button id="skipBtn" type="button" style="
                background: linear-gradient(135deg, #ef4444, #dc2626);
                color: white;
                border: none;
                padding: 12px 18px;
                border-radius: 10px;
                font-size: 15px;
                font-weight: 1000;
                cursor: pointer;
                transition: .15s ease;
                box-shadow: 0 10px 22px rgba(239,68,68,.25);
              ">ê±´ë„ˆë›°ê¸°</button>
            </div>

            <div style="margin-top: 10px; font-size: 12px; opacity:.88;">
              â€» ì´ë¦„ì€ ë­í‚¹ í‘œì‹œì—ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      `;

            document.body.appendChild(modal);

            const userNameInput = modal.querySelector('#userNameInput');
            const registerBtn   = modal.querySelector('#registerBtn');
            const skipBtn       = modal.querySelector('#skipBtn');

            userNameInput.focus();

            userNameInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') registerBtn.click();
                if (event.key === 'Escape') modal.remove();
            });

            registerBtn.addEventListener('click', () => {
                const userName = userNameInput.value.trim();
                if (!userName) {
                    userNameInput.style.borderColor = '#ef4444';
                    userNameInput.placeholder = 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!';
                    setTimeout(() => {
                        userNameInput.style.borderColor = 'rgba(255,255,255,.35)';
                        userNameInput.placeholder = 'ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 12ì)';
                    }, 1500);
                    return;
                }
                sendRanking(userName, level, tries);
                modal.remove();
            });

            skipBtn.addEventListener('click', () => modal.remove());

            modal.addEventListener('click', (event) => {
                if (event.target === modal) modal.remove();
            });
        }

        async function sendRanking(nickname, level, tries) {
            try {
                const res = await fetch('https://www.medcalc.co.kr/js/number-baseball-ranking-ko.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ nickname, level, tries })
                });
                if (!res.ok) throw new Error('ë­í‚¹ ë“±ë¡ ì‹¤íŒ¨');
                showSuccess('ë­í‚¹ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                fetchRanking(level);
            } catch (e) {
                showError('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    })();
</script>
</body>
</html>
