<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì•”í˜¸ ë©”ëª¨ ì „ì†¡ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 30px auto; padding: 10px; }
        textarea { width: 100%; height: 200px; }
        input[type="password"], input[type="text"] { width: 100%; padding: 8px; margin-top: 10px; }
        button { margin: 5px 0; padding: 8px 12px; }
    </style>
</head>
<body>
<h2>ğŸ” ì•”í˜¸ ë©”ëª¨ ì „ì†¡ê¸°</h2>
<p>ë¹„ë°€ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ê³  ì•”í˜¸ë¥¼ ê±¸ì–´ ì•ˆì „í•˜ê²Œ ê³µìœ í•˜ì„¸ìš”.</p>

<textarea id="memo" placeholder="ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
<div id="byteCount" style="text-align:right; font-size:12px;">0 / 1000 bytes</div>

<input type="password" id="password" placeholder="ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (ë°˜ë“œì‹œ ê¸°ì–µ)">
<button onclick="encryptMemo()">ğŸ”— ê³µìœ  ë§í¬ ë§Œë“¤ê¸°</button>

<input type="text" id="shareLink" readonly placeholder="ì—¬ê¸°ì— ë§í¬ê°€ ìƒì„±ë©ë‹ˆë‹¤.">
<button onclick="copyLink()">ğŸ“‹ ë§í¬ ë³µì‚¬</button>
<button onclick="resetForm()">ğŸ” ì´ˆê¸°í™”</button>

<div id="qrCode" style="text-align: center; margin-top: 20px;"></div>

<script>
    function getUtf8ByteLength(str) {
        return new TextEncoder().encode(str).length;
    }

    function updateByteCount() {
        const memo = document.getElementById("memo").value;
        const byteCount = getUtf8ByteLength(memo);
        const counter = document.getElementById("byteCount");
        counter.textContent = `${byteCount} / 1000 bytes`;
        counter.style.color = byteCount > 1000 ? "red" : "black";
    }

    document.getElementById("memo").addEventListener("input", updateByteCount);

    function encryptMemo() {
        const memo = document.getElementById("memo").value;
        const password = document.getElementById("password").value;
        if (!memo || !password) {
            alert("ë©”ëª¨ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        if (getUtf8ByteLength(memo) > 1000) {
            alert("ë©”ëª¨ê°€ ë„ˆë¬´ ê¹ë‹ˆë‹¤. 1000ë°”ì´íŠ¸ ì´í•˜ë¡œ ì¤„ì—¬ì£¼ì„¸ìš”.");
            return;
        }

        const salt = CryptoJS.lib.WordArray.random(128 / 8);
        const iv = CryptoJS.lib.WordArray.random(128 / 8);
        const key = CryptoJS.PBKDF2(password, salt, {
            keySize: 256 / 32,
            iterations: 1000
        });

        const encrypted = CryptoJS.AES.encrypt(memo, key, { iv: iv }).toString();

        const payload = JSON.stringify({
            ciphertext: encrypted,
            iv: iv.toString(CryptoJS.enc.Hex),
            salt: salt.toString(CryptoJS.enc.Hex)
        });

        const encoded = encodeURIComponent(btoa(payload));
        const url = `${location.origin + location.pathname}?note=${encoded}`;

        document.getElementById("shareLink").value = url;
        generateQRCode(url);
    }

    function copyLink() {
        const link = document.getElementById("shareLink");
        link.select();
        document.execCommand("copy");
        alert("ê³µìœ  ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function resetForm() {
        if (!confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        document.getElementById("memo").value = "";
        document.getElementById("password").value = "";
        document.getElementById("shareLink").value = "";
        document.getElementById("qrCode").innerHTML = "";
        updateByteCount();
    }

    function generateQRCode(url) {
        const qrCodeContainer = document.getElementById("qrCode");
        qrCodeContainer.innerHTML = "";
        const canvas = document.createElement("canvas");
        qrCodeContainer.appendChild(canvas);
        QRCode.toCanvas(canvas, url, function (error) {
            if (error) console.error("QR ì½”ë“œ ìƒì„± ì˜¤ë¥˜:", error);
        });
    }

    // ë³µí˜¸í™” ê¸°ëŠ¥ (URLì— note íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ë™ì‘)
    window.addEventListener("DOMContentLoaded", () => {
        updateByteCount();
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has("note")) {
            const encoded = urlParams.get("note");
            const payload = JSON.parse(atob(decodeURIComponent(encoded)));
            const password = prompt("ğŸ” ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (!password) return;

            const salt = CryptoJS.enc.Hex.parse(payload.salt);
            const iv = CryptoJS.enc.Hex.parse(payload.iv);
            const key = CryptoJS.PBKDF2(password, salt, {
                keySize: 256 / 32,
                iterations: 10002
            });

            try {
                const decrypted = CryptoJS.AES.decrypt(payload.ciphertext, key, { iv: iv }).toString(CryptoJS.enc.Utf8);
                if (!decrypted) throw new Error();
                alert("ğŸ”“ í•´ë… ì„±ê³µ! ë‚´ìš©:\n\n" + decrypted);
            } catch {
                alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ê±°ë‚˜ ë³µí˜¸í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }
    });
</script>
</body>
</html>
